<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Travel</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SortableJS (用於拖曳排序) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <!-- Chart.js (用於圓餅圖) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Leaflet CSS (地圖) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Leaflet JS (地圖) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&family=Great+Vibes&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        /* --- 史努比風格 & 深色模式設定 --- */
        body {
            background-color: #1c1917; 
            font-family: 'Zen Maru Gothic', sans-serif;
            color: #e7e5e4; 
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
        }
        
        .mobile-container {
            width: 100%;
            max-width: 480px;
            background-color: #1c1917; 
            height: 100%;
            position: relative;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* 強制地圖容器高度 */
        #map, #confirm-map, #hotel-confirm-map, #item-confirm-map {
            height: 100%; width: 100%; min-height: 100%; z-index: 0; background-color: #1c1917;
        }

        /* 自定義地圖標記 */
        .custom-div-icon { background: transparent; border: none; }
        .marker-pin {
            width: 32px; height: 32px; border-radius: 50%; 50%;
            background: #e7e5e4; border: 3px solid #1c1917;
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
            position: absolute; left: 50%; top: 50%;
            transform: translate(-50%, -50%);
            display: flex; align-items: center; justify-content: center;
            color: #1c1917; 
            font-size: 14px;
            font-weight: 900;
            font-family: 'Roboto Mono', monospace;
        }
        .marker-pin::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 8px solid #1c1917;
        }
        
        /* SortableJS 樣式 */
        .sortable-ghost { opacity: 0.4; background-color: #44403c !important; border: 2px dashed #fbbf24; }
        .sortable-drag { opacity: 0.95; background-color: #292524; box-shadow: 0 10px 20px rgba(0,0,0,0.5); transform: scale(1.02); z-index: 9999; }
        .sortable-chosen { background-color: #292524; }

        .draggable-item { -webkit-user-select: none; user-select: none; touch-action: pan-y; cursor: grab; transition: background-color 0.2s, transform 0.2s; }
        .draggable-item:active { cursor: grabbing; }
        
        /* 禁止拖曳的元素 (按鈕等) */
        .no-drag { cursor: pointer !important; -webkit-user-select: auto; user-select: auto; pointer-events: auto; }

        /* Modal 動畫 */
        .modal-enter-active, .modal-leave-active { transition: opacity 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; }
        .modal-enter-active .modal-content, .modal-leave-active .modal-content { transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .modal-enter-from .modal-content, .modal-leave-to .modal-content { transform: scale(0.9) translateY(20px); }

        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        .edit-icon-btn { background-color: transparent; box-shadow: none; border: none; transition: all 0.15s; color: rgba(255, 255, 255, 0.7); }
        .edit-icon-btn:hover { color: white; transform: scale(1.1); }
        .edit-icon-btn:active { transform: scale(0.9); }

        /* 資訊頁面 Input */
        .info-input { background-color: transparent; border-bottom: 1px solid #44403c; color: #e7e5e4; padding: 4px 0; width: 100%; font-size: 0.875rem; outline: none; transition: border-color 0.2s; }
        .info-input:focus { border-color: #fbbf24; }
        .info-label { font-size: 0.65rem; color: #a8a29e; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 2px; }

        /* 計算機按鈕 */
        .calc-btn {
            background-color: #292524; color: #e7e5e4; font-size: 1.25rem; font-weight: bold; border-radius: 0.75rem; padding: 1rem; border: 1px solid #44403c; transition: all 0.1s;
        }
        .calc-btn:active { background-color: #44403c; transform: scale(0.95); }
        .calc-btn.operator { color: #fbbf24; }
        .calc-btn.equals { background-color: #fbbf24; color: #1c1917; border-color: #fbbf24; }

        /* 浮現動畫 */
        @keyframes fadeSlideIn {
            from { opacity: 0; transform: translateX(-5px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .animate-data-appear {
            animation: fadeSlideIn 0.2s ease-out forwards;
        }
        
        /* 隱藏 Input Number 的箭頭 */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }

        /* iOS Date Input Fix */
        input[type="date"] {
            -webkit-appearance: none;
            appearance: none;
            min-height: 42px; /* Force height for iOS */
            position: relative; /* For icon positioning */
            cursor: pointer;
        }
        .fixed-height-input {
            height: 42px;
        }

        /* 隱藏 Scrollbar 但保留功能 */
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Time Input Minimal Style */
        .time-input-minimal {
            background: transparent;
            color: #e7e5e4;
            font-family: 'Roboto Mono', monospace;
            font-weight: bold;
            font-size: 0.875rem;
            border: none;
            outline: none;
            width: auto;
            text-align: center;
            cursor: pointer;
        }
        .time-input-minimal:focus {
            color: #fbbf24;
        }
        
        /* 修改：確保日期 icon 在深色模式下變成黃色 (保留給其他地方如 Modal 使用) */
        ::-webkit-calendar-picker-indicator {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            margin: 0;
            padding: 0;
            filter: invert(79%) sepia(68%) saturate(986%) hue-rotate(357deg) brightness(103%) contrast(106%);
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s;
            z-index: 5;
        }
        
        ::-webkit-calendar-picker-indicator:hover {
            opacity: 1;
        }

        /* 新增：專門給第一個行程使用的時間輸入框樣式，隱藏原生 icon */
        .time-input-first {
            background: transparent;
            border: none;
            outline: none;
            text-align: center;
            padding: 0;
            margin: 4px 0;
            width: 100%;
            cursor: pointer;
            /* 繼承父層字體設定，確保一致性 */
            color: inherit;
            font-family: inherit;
            font-size: inherit;
            font-weight: inherit;
            letter-spacing: inherit;
        }
        
        /* 隱藏 Chrome/Safari 的時間選擇器圖示 */
        .time-input-first::-webkit-calendar-picker-indicator {
            display: none !important;
            -webkit-appearance: none;
        }
        
        .time-input-first:focus {
            color: #fbbf24;
        }

        /* 新增：乾淨的時間輸入框樣式 (用於 Modal) */
        .time-input-clean {
            background: #1c1917;
            border: 1px solid #44403c;
            color: #e7e5e4;
            font-family: 'Roboto Mono', monospace;
            font-weight: bold;
            font-size: 2.5rem; /* 4xl */
            border-radius: 0.75rem; /* rounded-xl */
            padding: 0.5rem 0;
            text-align: center;
            outline: none;
            width: 100%;
            /* 移除預設外觀 */
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        .time-input-clean:focus {
            border-color: #fbbf24;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
        }
        
        /* 隱藏時間選擇器圖示 (時鐘/下拉) */
        .time-input-clean::-webkit-calendar-picker-indicator {
            display: none !important;
            -webkit-appearance: none;
        }
        
        /* 確保文字垂直置中 (針對部分瀏覽器) */
        .time-input-clean::-webkit-date-and-time-value {
             text-align: center; 
             margin-top: 0;
        }

        /* 新增：分離式時間輸入框樣式 */
        .time-part-input {
            background: #1c1917;
            border: 1px solid #44403c;
            color: #e7e5e4;
            font-family: 'Roboto Mono', monospace;
            font-weight: bold;
            font-size: 3rem; /* 適當的大字體 */
            border-radius: 0.75rem;
            padding: 0.25rem 0;
            text-align: center;
            outline: none;
            width: 80px; /* 固定寬度容納2位數 */
            /* 移除 input number 的箭頭 */
            -moz-appearance: textfield;
        }
        .time-part-input::-webkit-outer-spin-button,
        .time-part-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .time-part-input:focus {
            border-color: #fbbf24;
            background-color: #292524;
        }
    </style>
</head>
<body>

    <div id="app" class="mobile-container">
        
        <!-- ==================== 頁面 1: 首頁 (國家列表) ==================== -->
        <transition name="fade" mode="out-in">
            <div v-if="currentPage === 'home'" class="flex flex-col h-full relative" key="home">
                <div class="h-8 w-full bg-[#1c1917] shrink-0"></div>
                
                <!-- 列表區域 (獨立滾動) -->
                <div id="trip-list" class="flex-1 overflow-y-auto hide-scroll px-6 pt-10 pb-24 space-y-6">
                    <div v-for="trip in trips" :key="trip.id" :data-id="trip.id" @click="openTrip(trip)" class="draggable-item relative h-48 rounded-[2rem] overflow-hidden group cursor-pointer shadow-lg border border-[#292524] active:scale-95 transition-transform duration-200">
                        <img :src="trip.image" onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?auto=format&fit=crop&w=800&q=80';" class="absolute inset-0 w-full h-full object-cover opacity-70 group-hover:scale-105 transition-transform duration-500">
                        <div class="absolute inset-0 bg-gradient-to-t from-[#1c1917] via-transparent to-transparent"></div>
                        <div class="absolute top-5 left-6 z-10 flex flex-col items-start pointer-events-none">
                            <h2 class="text-3xl text-[#e7e5e4] leading-none mb-1 drop-shadow-md tracking-wide" style="font-family: 'Great Vibes', cursive;">{{ trip.title }}</h2>
                            <p class="text-[10px] text-[#e7e5e4] font-bold tracking-wide opacity-90 drop-shadow-sm" style="font-family: 'Zen Maru Gothic', sans-serif;">({{ trip.displayDate }})</p>
                        </div>
                        <!-- 加入 no-drag class 以及 .stop 修飾符防止事件冒泡影響拖曳 -->
                        <button @click.stop="openEditModal(trip)" @touchstart.stop class="no-drag absolute top-4 right-4 z-20 w-8 h-8 rounded-full flex items-center justify-center edit-icon-btn drop-shadow-md"><i class="fa-solid fa-ellipsis-vertical text-xs"></i></button>
                    </div>
                </div>

                <!-- 浮動按鈕 (黃色) -->
                <button @click="openAddTripModal" class="absolute bottom-8 right-8 z-[100] w-12 h-12 rounded-full bg-[#fbbf24] border-2 border-[#fbbf24] text-[#1c1917] flex items-center justify-center shadow-[0_0_20px_rgba(251,191,36,0.3)] hover:scale-105 active:scale-95 transition-all duration-300"><i class="fa-solid fa-plus text-xl"></i></button>
            </div>

            <!-- ==================== 頁面 2: 行程詳情 ==================== -->
            <div v-else class="h-full relative flex flex-col" key="detail">
                
                <!-- (Fixed) 返回與標題層 -->
                <div class="absolute top-0 left-0 w-full z-[60] pointer-events-none p-4 flex justify-between items-start h-20 bg-gradient-to-b from-black/60 to-transparent">
                    <button @click="currentPage = 'home'" class="w-8 h-8 flex items-center justify-center text-white hover:text-[#fbbf24] transition drop-shadow-md pointer-events-auto"><i class="fa-solid fa-arrow-left text-lg"></i></button>
                    <div class="flex flex-col items-end pointer-events-none mt-1">
                        <h1 class="text-2xl tracking-widest text-[#e7e5e4] leading-none font-bold drop-shadow-lg" style="font-family: 'Great Vibes', cursive;">{{ currentTrip.title }}</h1>
                        <span class="text-[9px] text-[#a8a29e] font-bold mt-0.5 tracking-wide drop-shadow-md" style="font-family: 'Zen Maru Gothic', sans-serif;">{{ currentTrip.displayDate }}</span>
                    </div>
                </div>

                <!-- 捲動容器 -->
                <div class="w-full h-full overflow-y-auto hide-scroll relative z-0" id="detail-scroller">
                    
                    <!-- Header -->
                    <header class="relative w-full h-[320px] shrink-0 overflow-hidden rounded-b-[50px] z-20 shadow-lg shadow-black/30">
                        <img :src="currentTrip.image" onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?auto=format&fit=crop&w=800&q=80';" class="absolute inset-0 w-full h-full object-cover object-left opacity-90">
                        <div class="absolute inset-0 bg-gradient-to-t from-[#1c1917] via-[#1c1917]/20 to-transparent"></div>
                        
                        <!-- Tabs -->
                        <div class="absolute bottom-5 right-6 z-30 flex gap-3">
                            <button @click="currentTab = 'itinerary'" class="w-11 h-11 rounded-full flex items-center justify-center transition-all duration-300 shadow-lg backdrop-blur-md border border-white/10" :class="currentTab === 'itinerary' ? 'bg-[#e7e5e4] text-[#1c1917] scale-110' : 'bg-[#1c1917]/60 text-[#a8a29e] hover:bg-[#1c1917]/80'"><i class="fa-regular fa-calendar-days text-lg"></i></button>
                            <button @click="currentTab = 'info'" class="w-11 h-11 rounded-full flex items-center justify-center transition-all duration-300 shadow-lg backdrop-blur-md border border-white/10" :class="currentTab === 'info' ? 'bg-[#e7e5e4] text-[#1c1917] scale-110' : 'bg-[#1c1917]/60 text-[#a8a29e] hover:bg-[#1c1917]/80'"><i class="fa-solid fa-circle-info text-lg"></i></button>
                            <button @click="currentTab = 'expenses'" class="w-11 h-11 rounded-full flex items-center justify-center transition-all duration-300 shadow-lg backdrop-blur-md border border-white/10" :class="currentTab === 'expenses' ? 'bg-[#e7e5e4] text-[#1c1917] scale-110' : 'bg-[#1c1917]/60 text-[#a8a29e] hover:bg-[#1c1917]/80'"><i class="fa-solid fa-coins text-lg"></i></button>
                        </div>
                    </header>

                    <!-- Main -->
                    <main class="relative z-10 bg-[#1c1917] min-h-screen pb-32 pt-4">
                        
                        <!-- 行程表 Tab -->
                        <transition name="fade" mode="out-in">
                            <div v-show="currentTab === 'itinerary'" class="h-full flex flex-col relative">
                                <!-- 頂部資訊列 -->
                                <div class="mx-6 mt-0 mb-2 p-3 rounded-3xl bg-[#292524]/80 border border-[#44403c] grid grid-cols-3 gap-2 items-stretch backdrop-blur-sm shadow-sm shrink-0">
                                    
                                    <!-- 1. 天氣與國家欄位 -->
                                    <div class="flex flex-col items-center justify-center border-r border-[#44403c]/50 pr-2">
                                        <div v-if="weatherLoading" class="flex flex-col items-center justify-center h-full gap-1">
                                            <i class="fa-solid fa-circle-notch fa-spin text-[#fbbf24] text-sm"></i>
                                            <span class="text-[8px] text-[#57534e] font-bold">UPDATING</span>
                                        </div>
                                        <div v-else-if="weather" class="flex flex-col items-center justify-center">
                                            <div class="flex items-center gap-1 mb-0.5">
                                                <div class="text-xl text-[#fbbf24]"><i :class="weather.icon"></i></div>
                                                <div class="text-xl font-bold text-[#e7e5e4] font-sans leading-none">{{ weather.temp }}°</div>
                                            </div>
                                            <div class="text-[10px] text-[#a8a29e] font-bold tracking-wide truncate max-w-[80px] text-center uppercase">{{ weather.locationLabel }}</div>
                                        </div>
                                        <div v-else class="flex items-center justify-center">
                                            <span class="text-[10px] text-[#57534e]">No Data</span>
                                        </div>
                                    </div>

                                    <!-- 2. 時間欄位 -->
                                    <div class="flex flex-col items-center justify-center border-r border-[#44403c]/50 px-1">
                                        <div class="flex items-center gap-1 mb-1">
                                            <span class="text-[8px] text-[#78716c] bg-[#1c1917] px-1 rounded border border-[#44403c]">TW</span>
                                            <span class="text-xs text-[#e7e5e4] font-mono">{{ currentTimeTW }}</span>
                                        </div>
                                        <div class="flex items-center gap-1">
                                            <span class="text-[8px] text-[#fbbf24] bg-[#1c1917] px-1 rounded border border-[#44403c]">LOC</span>
                                            <span v-if="weatherLoading" class="text-xs text-[#57534e] font-mono font-bold animate-pulse">...</span>
                                            <span v-else class="text-xs text-[#fbbf24] font-mono font-bold">{{ currentTimeLocal }}</span>
                                        </div>
                                    </div>

                                    <div class="flex items-center gap-1">
                                        <button @click="switchView('list')" class="flex-1 h-full rounded-xl flex items-center justify-center transition-all duration-200 border" :class="currentView === 'list' ? 'bg-[#e7e5e4] text-[#1c1917] border-[#e7e5e4] shadow-md' : 'bg-transparent text-[#78716c] border-transparent hover:bg-[#44403c]/30'"><i class="fa-solid fa-list text-xs"></i></button>
                                        <button @click="switchView('map')" class="flex-1 h-full rounded-xl flex items-center justify-center transition-all duration-200 border" :class="currentView === 'map' ? 'bg-[#e7e5e4] text-[#1c1917] border-[#e7e5e4] shadow-md' : 'bg-transparent text-[#78716c] border-transparent hover:bg-[#44403c]/30'"><i class="fa-regular fa-map text-xs"></i></button>
                                    </div>
                                </div>

                                <div v-show="currentView === 'map'" class="relative mx-6 mb-6 rounded-[2rem] overflow-hidden border border-[#292524] shadow-inner bg-[#1c1917] h-[65vh]">
                                    <div id="map" class="w-full h-full z-0"></div>
                                </div>

                                <div v-if="currentView === 'list'" class="mb-4 shrink-0">
                                    <div class="flex overflow-x-auto no-scrollbar gap-3 px-6 pb-2 pt-2">
                                        <button v-for="date in dates" :key="date.full" @click="selectedDate = date" class="flex flex-col items-center justify-center flex-shrink-0 w-[4.5rem] h-[4.5rem] rounded-full border-2 transition-all duration-300 snap-center shadow-lg" :class="selectedDate.full === date.full ? 'bg-[#e7e5e4] border-[#e7e5e4] text-[#1c1917] scale-105 shadow-[#e7e5e4]/30' : 'bg-[#292524] border-[#44403c] text-[#78716c] opacity-70 hover:opacity-100 hover:border-[#78716c]'">
                                            <span class="text-xl font-bold leading-none mb-1 font-sans">{{ date.day }}</span><span class="text-xs font-medium opacity-90">{{ date.displayDate }}</span>
                                        </button>
                                    </div>
                                </div>

                                <!-- 列表區域 (連接線 + 卡片) -->
                                <div v-if="currentView === 'list'" class="px-6 space-y-4">
                                    <div class="relative pl-0 space-y-6" id="itinerary-list">
                                        <!-- Vertical Line Connector -->
                                        <div class="absolute left-[2.5rem] top-4 bottom-4 w-[2px] bg-[#44403c] z-0 rounded-full"></div>

                                        <div v-if="filteredItinerary.length === 0" class="text-center text-[#57534e] py-10 text-xs relative z-10">這天還沒有行程，按右下角新增！</div>
                                        
                                        <div v-for="(item, index) in filteredItinerary" :key="item.id" :data-id="item.id" class="relative group draggable-item z-10">
                                            <div class="bg-[#292524] rounded-3xl border border-[#1c1917] hover:border-[#44403c] transition-colors shadow-md group-hover:shadow-lg flex overflow-hidden relative">
                                                <!-- Left Time/Icon Col -->
                                                <div class="w-20 bg-[#23201f] flex flex-col items-center justify-center py-4 border-r border-[#44403c]/50 shrink-0 pointer-events-none relative z-10">
                                                    <div class="w-10 h-10 rounded-full flex items-center justify-center shadow-inner mb-2 border-2 border-[#1c1917]" :style="{ backgroundColor: getMarkerColor(item.type) }"><i :class="getCategoryIcon(item.type)" class="text-[#1c1917] text-sm"></i></div>
                                                    <div class="flex flex-col items-center gap-0.5 pointer-events-auto">
                                                        
                                                        <!-- 修改：第一個行程的時間顯示 -->
                                                        <!-- 改用 button 顯示純文字，確保與下方 span 字體完全一致 -->
                                                        <button v-if="index === 0" 
                                                                @click.stop="openTimeEditModal(item)"
                                                                class="no-drag text-[#e7e5e4] text-lg font-bold font-mono tracking-wide leading-none my-1 hover:text-[#fbbf24] transition-colors outline-none bg-transparent border-0 p-0 cursor-pointer"
                                                                title="點擊修改出發時間">
                                                            {{ item.arrivalTime }}
                                                        </button>
                                                               
                                                        <!-- 如果不是第一個：顯示純文字 (自動計算) -->
                                                        <span v-else class="text-[#e7e5e4] text-lg font-bold font-mono tracking-wide leading-none my-1">{{ item.arrivalTime }}</span>
                                                        
                                                        <span class="text-[9px] text-[#a8a29e] font-mono">{{ item.durationHr }}h{{ item.durationMin > 0 ? item.durationMin : '' }}</span>
                                                        <span class="text-[10px] font-bold text-[#78716c] font-mono leading-none mt-0.5">{{ getDepartureTime(item.arrivalTime, item.durationHr, item.durationMin) }}</span>
                                                    </div>
                                                </div>
                                                
                                                <!-- Right Info Col -->
                                                <div class="flex-1 p-4 flex flex-col justify-center relative min-w-0">
                                                    <!-- Top Row: Title + Nav + Menu -->
                                                    <div class="flex items-center justify-between mb-2">
                                                        <div class="flex items-center gap-2 overflow-hidden flex-1">
                                                            <h3 class="text-lg font-bold text-[#e7e5e4] tracking-wide leading-tight truncate">{{ item.title }}</h3>
                                                            <!-- Nav Icon (no-drag) -->
                                                            <!-- 修改：將 button 改為 a 標籤，href 直接綁定 Google Maps 連結 -->
                                                            <a :href="getMapUrl(item)" target="_blank" @click.stop class="no-drag w-6 h-6 rounded-full bg-[#fbbf24] text-[#1c1917] flex items-center justify-center hover:bg-white shadow-lg active:scale-90 shrink-0 transition-transform">
                                                                <i class="fa-solid fa-location-arrow text-[10px]"></i>
                                                            </a>
                                                        </div>
                                                        <!-- Menu (3 dots) (no-drag) -->
                                                        <div class="relative shrink-0 ml-1">
                                                            <button @click.stop="openEditItemModal(item)" @touchstart.stop class="no-drag w-8 h-8 rounded-full flex items-center justify-center text-[#78716c] hover:bg-[#44403c] transition"><i class="fa-solid fa-ellipsis-vertical text-xs"></i></button>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Notes (Editable Textarea) (no-drag implicitly mostly, but better add no-drag if conflict) -->
                                                    <textarea 
                                                        v-model="item.notes" 
                                                        @input="autoResize($event.target)"
                                                        @touchstart.stop
                                                        class="no-drag w-full bg-[#1c1917]/50 rounded-xl border border-[#44403c]/30 p-2 text-base text-[#a8a29e] placeholder-[#57534e] outline-none focus:border-[#fbbf24] transition overflow-hidden auto-resize-textarea" 
                                                        rows="1" 
                                                        placeholder="備註..."></textarea>
                                                </div>
                                            </div>
                                            
                                            <!-- Travel Time Connector (Optional visual) -->
                                            <div v-if="index < filteredItinerary.length - 1" class="flex justify-center py-2 relative z-10">
                                                <!-- 點擊此按鈕開啟交通時間編輯 Modal (no-drag) -->
                                                <button @click.stop="openTravelTimeModal(item)" @touchstart.stop class="no-drag px-3 py-1 rounded-full bg-[#1c1917] text-[#a8a29e] text-[10px] font-bold shadow-md border border-[#44403c] flex items-center gap-2 hover:border-[#fbbf24] hover:text-[#fbbf24] transition-all z-20">
                                                    <!-- 顯示 icon (點擊切換交通工具) -->
                                                    <div @click.stop="toggleTravelMode(item)" @touchstart.stop class="flex items-center justify-center w-4 h-4 hover:text-white transition">
                                                        <i :class="getTravelIcon(item.travelMode)" class="text-xs"></i>
                                                    </div>
                                                    
                                                    <!-- 顯示交通時間 (資料來自 item.calculatedTravelTime) -->
                                                    <span>{{ formatTravelTime(item.calculatedTravelTime) }}</span>
                                                    
                                                    <i class="fa-solid fa-pen text-[8px] opacity-50 ml-1"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </transition>

                        <!-- ... (Other Tabs remains same) ... -->
                        <!-- 資訊頁面 Tab -->
                        <div v-show="currentTab === 'info'" class="h-full flex flex-col relative overflow-hidden">
                            <div class="px-6 pt-6 pb-24 space-y-6">
                                <div class="bg-[#292524] rounded-3xl p-5 border border-[#44403c] shadow-lg">
                                    <h3 class="text-[#fbbf24] font-bold mb-4 flex items-center gap-2 text-lg"><i class="fa-solid fa-plane-departure"></i> 航班資訊</h3>
                                    
                                    <!-- 合併後的航班資訊區塊 (Dynamic) -->
                                    <div class="bg-[#1c1917] p-4 rounded-2xl mb-4 border border-[#44403c] relative transition-all duration-300">
                                        <div class="flex justify-between items-center border-b border-[#44403c] pb-1 mb-2">
                                            <div class="text-[10px] text-[#fbbf24] font-bold tracking-widest uppercase flex items-center gap-2">
                                                <span>{{ currentFlightType === 'out' ? '去程' : '回程' }}</span>
                                            </div>
                                            <div class="flex items-center gap-3">
                                                <button @click="toggleFlightType" class="text-[10px] px-3 py-1 rounded-full bg-[#44403c] text-[#fbbf24] hover:bg-[#57534e] transition">
                                                    {{ currentFlightType === 'out' ? '去程' : '回程' }} <i class="fa-solid fa-repeat ml-1"></i>
                                                </button>
                                                <button @click="openFlightModal(currentFlightType)" class="text-[#a8a29e] hover:text-white transition">
                                                    <i class="fa-solid fa-gear text-xs"></i>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <!-- 資料顯示區 (回復中文標籤) -->
                                        <div class="grid grid-cols-2 gap-3 mb-2">
                                            <div>
                                                <div class="info-label">航線</div>
                                                <div class="text-[#e7e5e4] text-sm font-mono font-bold flex items-center gap-1">
                                                    <span>{{ info.flight[currentFlightType].depAirport || '---' }}</span>
                                                    <i class="fa-solid fa-plane text-[10px] text-[#57534e]"></i>
                                                    <span>{{ info.flight[currentFlightType].arrAirport || '---' }}</span>
                                                </div>
                                            </div>
                                            <div>
                                                <div class="info-label">航班編號</div>
                                                <div class="text-[#e7e5e4] text-sm font-mono">{{ info.flight[currentFlightType].number || '---' }}</div>
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-3 gap-2 border-t border-[#44403c]/50 pt-2">
                                            <div class="text-center">
                                                <div class="info-label">起飛</div>
                                                <div class="text-[#e7e5e4] text-lg font-mono font-bold leading-none">{{ info.flight[currentFlightType].dep || '--:--' }}</div>
                                            </div>
                                            <div class="text-center">
                                                <div class="info-label">抵達</div>
                                                <div class="text-[#e7e5e4] text-lg font-mono font-bold leading-none">{{ info.flight[currentFlightType].arr || '--:--' }}</div>
                                                <div v-if="info.flight[currentFlightType].arrDayOffset > 0" class="text-[8px] text-[#fbbf24] font-bold mt-0.5">+{{ info.flight[currentFlightType].arrDayOffset }} 天</div>
                                            </div>
                                            <div class="text-center">
                                                <div class="info-label">時長</div>
                                                <div class="text-[#a8a29e] text-sm font-mono leading-none mt-1">{{ info.flight[currentFlightType].duration || '--' }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Hotel Info -->
                                <div class="bg-[#292524] rounded-3xl p-5 border border-[#44403c] shadow-lg relative">
                                    <div class="flex justify-between items-center mb-4">
                                        <h3 class="text-[#fbbf24] font-bold flex items-center gap-2 text-lg"><i class="fa-solid fa-hotel"></i> 住宿資訊</h3>
                                        <div class="flex items-center gap-3">
                                            <button @click="toggleHotel" class="text-[10px] px-3 py-1 rounded-full bg-[#44403c] text-[#fbbf24] hover:bg-[#57534e] transition">Hotel {{ info.hotel.currentIndex + 1 }} <i class="fa-solid fa-repeat ml-1"></i></button>
                                            <button @click="openHotelModal" class="text-[#a8a29e] hover:text-white transition relative z-10 p-2"><i class="fa-solid fa-gear"></i></button>
                                        </div>
                                    </div>
                                    
                                    <div class="space-y-4">
                                        <div>
                                            <div class="info-label">飯店名稱 (Hotel Name)</div>
                                            <div class="text-[#e7e5e4] text-base font-bold min-h-[1.5rem]">{{ info.hotel.list[info.hotel.currentIndex].name }}</div>
                                        </div>
                                        <div>
                                            <div class="info-label">電話 (Phone)</div>
                                            <div class="text-[#e7e5e4] text-sm min-h-[1.25rem]">{{ info.hotel.list[info.hotel.currentIndex].phone }}</div>
                                        </div>
                                        <div>
                                            <div class="flex items-center gap-2">
                                                <div class="info-label mb-0">住址 (Address)</div>
                                                <!-- 修改：住宿資訊的導航按鈕也改為 a 標籤 -->
                                                <a :href="getMapUrl(info.hotel.list[info.hotel.currentIndex])" target="_blank" class="w-5 h-5 rounded-full bg-[#fbbf24] text-[#1c1917] flex items-center justify-center hover:bg-[#f59e0b] shadow-md active:scale-90 transition shrink-0" title="導航">
                                                    <i class="fa-solid fa-location-arrow text-[8px]"></i>
                                                </a>
                                            </div>
                                            <div class="text-[#e7e5e4] text-sm min-h-[1.25rem] break-words">{{ info.hotel.list[info.hotel.currentIndex].address }}</div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Visa -->
                                <div class="bg-[#292524] rounded-3xl p-5 border border-[#44403c] shadow-lg">
                                    <div class="flex justify-between items-center mb-2">
                                        <h3 class="text-[#fbbf24] font-bold flex items-center gap-2 text-lg"><i class="fa-solid fa-passport"></i> 簽證資訊</h3>
                                        <button @click="toggleUser('visa')" class="text-[10px] px-3 py-1 rounded-full bg-[#44403c] text-[#fbbf24] hover:bg-[#57534e] transition">{{ info.visa.currentUser === 'user1' ? 'HungJung Hsu' : 'ChiFen Tai' }} <i class="fa-solid fa-repeat ml-1"></i></button>
                                    </div>
                                    <div>
                                        <div class="relative h-48 bg-[#1c1917] rounded-xl border border-[#44403c] overflow-hidden flex items-center justify-center group cursor-pointer hover:border-[#fbbf24] transition border-dashed" @click="triggerFileInput('visa-file')">
                                            <img v-if="info.visa.images[info.visa.currentUser]" :src="info.visa.images[info.visa.currentUser]" class="w-full h-full object-contain">
                                            <div v-else class="text-[#57534e] flex flex-col items-center"><i class="fa-solid fa-id-card text-2xl mb-2"></i><span class="text-[10px]">點擊上傳 {{ info.visa.currentUser === 'user1' ? 'HungJung Hsu' : 'ChiFen Tai' }} 簽證</span></div>
                                            <input type="file" id="visa-file" class="hidden" accept="image/*" @change="(e) => handleImageUpload(e, 'visa')">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- ★★★ Check List ★★★ -->
                                <div class="bg-[#292524] rounded-3xl p-5 border border-[#44403c] shadow-lg">
                                    <h3 class="text-[#fbbf24] font-bold mb-4 flex items-center gap-2 text-lg"><i class="fa-solid fa-list-check"></i> Check List</h3>
                                    <div class="space-y-4">
                                        <div v-for="(items, category) in info.checklist" :key="category">
                                            <div class="flex justify-between items-end border-b border-[#44403c] mb-2 pb-1">
                                                <div class="text-[10px] text-[#78716c] font-bold uppercase tracking-widest">{{ category }}</div>
                                                <button @click="openAddChecklistModal(category)" class="text-[#a8a29e] hover:text-[#fbbf24] transition mb-0.5"><i class="fa-solid fa-plus text-xs"></i></button>
                                            </div>
                                            <div class="grid grid-cols-2 gap-2">
                                                <div v-for="(item, idx) in items" :key="idx" 
                                                     class="flex items-center gap-2 p-2 rounded-xl border transition-all cursor-pointer select-none relative overflow-hidden"
                                                     :class="item.checked ? 'bg-[#fbbf24]/10 border-[#fbbf24] text-[#fbbf24]' : 'bg-[#1c1917] border-[#44403c] text-[#a8a29e]'"
                                                     @click="toggleChecklist(item)"
                                                     @touchstart="startLongPress(category, idx)" @touchend="clearLongPress" @touchmove="clearLongPress"
                                                     @mousedown="startLongPress(category, idx)" @mouseup="clearLongPress" @mouseleave="clearLongPress"
                                                     @contextmenu.prevent
                                                >
                                                    <div class="w-4 h-4 rounded border flex items-center justify-center transition-colors"
                                                         :class="item.checked ? 'bg-[#fbbf24] border-[#fbbf24]' : 'border-[#57534e]'">
                                                        <i v-if="item.checked" class="fa-solid fa-check text-[#1c1917] text-[10px]"></i>
                                                    </div>
                                                    <span class="text-sm font-medium">{{ item.name }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ★★★ (2) 花費頁面 Tab ★★★ -->
                        <div v-show="currentTab === 'expenses'" class="h-full flex flex-col relative">
                            <!-- (略，保持不變) -->
                            <!-- 頂部固定區域 (匯率 + 總覽 + 分類) -->
                            <div class="px-6 pt-6 shrink-0 bg-[#1c1917] z-20 pb-0 shadow-sm relative">
                                 <!-- 匯率轉換器 -->
                                <div class="bg-[#292524] rounded-2xl p-3 border border-[#44403c] mb-4 flex items-center justify-between gap-3 shadow-lg">
                                    <div class="flex-1 relative">
                                        <label class="absolute -top-2 left-2 text-[8px] bg-[#292524] px-1 text-white font-bold">{{ currency.code }}</label>
                                        <input type="number" v-model="convForeign" @input="onConvForeignInput" class="w-full bg-transparent border border-[#44403c] rounded-xl px-3 py-2 text-[#e7e5e4] text-base focus:border-[#fbbf24] outline-none text-center font-mono placeholder-[#57534e]" placeholder="0">
                                        <button @click="openCalculator('convForeign')" class="absolute right-2 bottom-2 text-[#fbbf24]"><i class="fa-solid fa-calculator"></i></button>
                                    </div>
                                    <div class="text-[#fbbf24] text-xs"><i class="fa-solid fa-arrow-right-arrow-left"></i></div>
                                    <div class="flex-1 relative">
                                         <label class="absolute -top-2 left-2 text-[8px] bg-[#292524] px-1 text-white font-bold">TWD</label>
                                        <input type="number" v-model="convTWD" @input="onConvTWDInput" class="w-full bg-transparent border border-[#44403c] rounded-xl px-3 py-2 text-[#e7e5e4] text-base focus:border-[#fbbf24] outline-none text-center font-mono placeholder-[#57534e]" placeholder="0">
                                        <button @click="openCalculator('convTWD')" class="absolute right-2 bottom-2 text-[#fbbf24]"><i class="fa-solid fa-calculator"></i></button>
                                    </div>
                                </div>

                                <!-- 總花費卡片 -->
                                <div class="bg-[#292524] rounded-3xl p-4 border border-[#44403c] shadow-lg mb-6 relative overflow-hidden flex items-center justify-between gap-2 transition-all hover:shadow-[0_4px_10px_rgba(0,0,0,0.5)]">
                                    <!-- Left Section: Info & Toggles -->
                                    <div class="z-10 flex flex-col gap-2 shrink-0 mr-1 max-w-[45%]">
                                        <div :class="totalExpenseFontClass" class="font-bold font-mono text-[#e7e5e4] leading-none whitespace-nowrap">$ {{ totalExpensesTWD.toLocaleString() }}</div>
                                        <button @click="showCurrencyModal = true" class="flex items-center gap-1 text-[9px] font-bold text-[#a8a29e] w-fit cursor-pointer hover:text-[#fbbf24] transition">
                                            <span>1 {{ currency.code }} = {{ currency.rate ? currency.rate.toFixed(4) : '...' }} TWD</span>
                                        </button>
                                        <div class="flex gap-1 mt-1">
                                             <button @click="chartType='category'" class="text-[9px] px-2 py-0.5 rounded-full border border-[#44403c] font-bold transition-all" :class="chartType==='category' ? 'bg-[#fbbf24] text-[#1c1917]' : 'bg-transparent text-[#a8a29e] hover:bg-[#44403c]'">類別</button>
                                             <button @click="chartType='payment'" class="text-[9px] px-2 py-0.5 rounded-full border border-[#44403c] font-bold transition-all" :class="chartType==='payment' ? 'bg-[#fbbf24] text-[#1c1917]' : 'bg-transparent text-[#a8a29e] hover:bg-[#44403c]'">付款方式</button>
                                        </div>
                                    </div>
                                    
                                    <!-- Right Section: Chart & Legend -->
                                    <div class="flex items-center gap-1 flex-1 justify-end min-w-0 pr-4"> 
                                        <!-- Chart -->
                                        <div class="relative z-10 w-16 h-16 shrink-0 flex items-center justify-center">
                                             <canvas id="expenseChart"></canvas>
                                        </div>
                                        <!-- Legend -->
                                        <div class="flex flex-col justify-center items-start pl-2 z-10 h-20 overflow-y-auto no-scrollbar w-32">
                                            <div v-for="item in chartLegendData" :key="item.label" class="flex items-center justify-between w-full mb-1">
                                                <div class="flex items-center gap-1.5 overflow-hidden min-w-0 flex-1 justify-start">
                                                    <div class="w-1.5 h-1.5 rounded-full shrink-0" :style="{backgroundColor: item.color}"></div>
                                                    <span class="text-[#a8a29e] truncate text-[9px] text-left">{{ item.label }}</span>
                                                </div>
                                                <div class="flex items-center shrink-0 ml-1">
                                                    <span :class="getLegendValSize(item.value)" class="text-[#e7e5e4] font-mono leading-none">${{ item.value.toLocaleString() }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 3. 分類 Bar -->
                                <div class="w-auto -mx-6 px-6 border-b border-[#292524] pb-2">
                                    <div class="grid grid-cols-7 gap-1 w-full">
                                        <button v-for="cat in expenseCategories" :key="cat.key" 
                                                @click="expenseFilter = cat.key"
                                                class="rounded-t-xl py-2 text-xs font-bold transition-all transform origin-bottom border-t border-l border-r border-[#44403c] px-0 flex items-center justify-center"
                                                :class="[
                                                    expenseFilter === cat.key 
                                                        ? 'bg-[#fbbf24] text-[#1c1917] z-10 scale-110 shadow-md border-[#fbbf24]' 
                                                        : 'bg-[#292524] text-[#a8a29e] border-[#44403c] opacity-70 hover:opacity-100 hover:bg-[#44403c] scale-100'
                                                ]">
                                            <span class="truncate px-0.5">{{ cat.label }}</span>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- 滾動區域：列表 -->
                            <div class="px-6 pt-4 bg-[#1c1917] relative space-y-3">
                                <!-- Overlay to close menu when clicking outside -->
                                <div v-if="activeExpenseMenuId" @click="activeExpenseMenuId = null" class="fixed inset-0 z-30 bg-transparent"></div>

                                <div v-for="exp in filteredExpensesList" :key="exp.id" class="bg-[#292524] p-4 rounded-2xl border border-[#44403c] flex justify-between items-center shadow-md relative z-10">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-full bg-[#1c1917] flex items-center justify-center text-[#fbbf24] border border-[#44403c]">
                                            <i :class="getExpenseIcon(exp.category)"></i>
                                        </div>
                                        <div>
                                            <div class="text-sm font-bold text-[#e7e5e4]">{{ exp.title }}</div>
                                            <div class="text-[10px] text-[#a8a29e]">{{ exp.date }} · {{ exp.payment }}</div>
                                            <div v-if="exp.notes" class="text-[9px] text-[#57534e] italic mt-0.5">{{ exp.notes }}</div>
                                        </div>
                                    </div>
                                    <div class="flex items-start gap-2">
                                        <div class="text-right">
                                            <div class="text-sm font-bold text-[#e7e5e4] font-mono">$ {{ exp.amountTWD.toLocaleString() }}</div>
                                            <div class="text-[10px] text-[#78716c] font-mono">{{ currency.code }} {{ exp.amountForeign.toLocaleString() }}</div>
                                        </div>
                                        <div class="relative">
                                            <button @click.stop="editExpense(exp)" class="w-6 h-6 flex items-center justify-center text-[#78716c] hover:text-[#e7e5e4] transition rounded-full hover:bg-[#44403c] bg-transparent">
                                                <i class="fa-solid fa-ellipsis-vertical text-xs"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div v-if="filteredExpensesList.length === 0" class="text-center text-[#57534e] py-10 text-xs">此分類尚無花費紀錄</div>
                            </div>
                        </div>

                    </main>
                </div>

                <!-- 浮動按鈕區 (固定在螢幕右下角) -->
                <div class="absolute bottom-6 right-6 z-[100] flex flex-col gap-4 pointer-events-none">
                     <!-- 行程頁面 FAB (已更換為黃色) -->
                    <button v-if="currentTab === 'itinerary' && currentView === 'list'" @click="openAddItineraryModal" class="w-12 h-12 rounded-full bg-[#fbbf24] border-2 border-[#fbbf24] text-[#1c1917] flex items-center justify-center shadow-[0_0_20px_rgba(251,191,36,0.3)] hover:scale-105 active:scale-95 transition-all duration-300 pointer-events-auto">
                        <i class="fa-solid fa-plus text-lg"></i>
                    </button>

                    <!-- 消費頁面 FAB -->
                    <button v-if="currentTab === 'expenses'" @click="openAddExpenseModal" class="w-12 h-12 rounded-full bg-[#fbbf24] text-[#1c1917] flex items-center justify-center shadow-lg hover:scale-110 active:scale-95 transition border border-[#fbbf24] pointer-events-auto">
                        <i class="fa-solid fa-plus text-xl"></i>
                    </button>
                </div>

            </div>
        </transition>

        <!-- Modals -->
        <transition name="modal"><div v-if="showCurrencyModal" class="fixed inset-0 z-[200] flex items-center justify-center pointer-events-none"><div class="absolute inset-0 bg-black/80 pointer-events-auto" @click="showCurrencyModal = false"></div><div class="relative bg-[#292524] w-72 p-6 rounded-3xl border border-[#44403c] pointer-events-auto shadow-2xl"><div class="grid grid-cols-2 gap-3"><button v-for="(rate, code) in exchangeRates" :key="code" @click="selectCurrency(code)" class="p-3 rounded-xl border flex flex-col items-center gap-1 transition active:scale-95" :class="currency.code === code ? 'bg-[#fbbf24] border-[#fbbf24] text-[#1c1917]' : 'bg-[#1c1917] border-[#44403c] text-[#a8a29e]'"><span class="font-bold text-lg">{{ code }}</span><span class="text-[10px]">1 {{ code }} ≈ {{ rate.toFixed(4) }} TWD</span></button></div></div></div></transition>
        
        <!-- Travel Time Edit Modal (New) -->
        <transition name="modal">
            <div v-if="showTravelTimeModal" class="fixed inset-0 z-[200] flex items-center justify-center pointer-events-none">
                <div @click="showTravelTimeModal = false" class="absolute inset-0 bg-black/60 backdrop-blur-sm pointer-events-auto transition-opacity duration-300"></div>
                <div class="relative bg-[#292524] w-80 p-6 rounded-3xl border border-[#44403c] pointer-events-auto shadow-2xl">
                    <div class="text-center mb-4">
                        <h3 class="text-[#fbbf24] font-bold text-sm">編輯交通方式與時間</h3>
                        <p class="text-[10px] text-[#a8a29e] mt-1">前往下個地點的設定</p>
                    </div>

                    <!-- 1. 交通方式選擇 (新增) -->
                    <div class="flex justify-center gap-4 mb-6">
                        <button v-for="mode in ['car', 'bus', 'walking']" :key="mode" 
                                @click="travelTimeForm.mode = mode"
                                class="w-12 h-12 rounded-full flex items-center justify-center border transition-all duration-200"
                                :class="travelTimeForm.mode === mode ? 'bg-[#fbbf24] border-[#fbbf24] text-[#1c1917] scale-110 shadow-lg' : 'bg-[#1c1917] border-[#44403c] text-[#78716c] hover:border-[#a8a29e]'">
                            <i :class="[getTravelIcon(mode), 'text-lg']"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-3">
                        <!-- 自動計算選項 -->
                        <button @click="setTravelMode('auto')" class="w-full p-3 rounded-xl border flex items-center justify-between transition" :class="travelTimeForm.type === 'auto' ? 'bg-[#fbbf24]/10 border-[#fbbf24] text-[#fbbf24]' : 'bg-[#1c1917] border-[#44403c] text-[#a8a29e]'">
                            <div class="flex flex-col items-start">
                                <span class="text-xs font-bold flex items-center gap-2"><i class="fa-solid fa-wand-magic-sparkles"></i> 自動計算</span>
                                <span class="text-[9px] opacity-70 mt-0.5" v-if="travelTimeForm.type === 'auto'">將依照 {{ getModeName(travelTimeForm.mode) }} 重新估算</span>
                            </div>
                            <span v-if="travelTimeForm.type === 'auto'" class="text-[10px]"><i class="fa-solid fa-check"></i></span>
                        </button>
                        
                        <!-- 手動輸入選項 -->
                        <button @click="setTravelMode('manual')" class="w-full p-3 rounded-xl border flex flex-col items-start gap-2 transition" :class="travelTimeForm.type === 'manual' ? 'bg-[#fbbf24]/10 border-[#fbbf24] text-[#fbbf24]' : 'bg-[#1c1917] border-[#44403c] text-[#a8a29e]'">
                            <div class="w-full flex justify-between items-center">
                                <span class="text-xs font-bold flex items-center gap-2"><i class="fa-regular fa-keyboard"></i> 手動輸入</span>
                                <span v-if="travelTimeForm.type === 'manual'" class="text-[10px]"><i class="fa-solid fa-check"></i></span>
                            </div>
                            
                            <!-- 修改：手動輸入欄位 (小時 + 分鐘) -->
                            <div v-if="travelTimeForm.type === 'manual'" class="w-full flex items-center justify-center gap-3 mt-2" @click.stop>
                                <div class="flex items-center gap-1">
                                    <input v-model.number="travelTimeForm.hours" type="number" min="0" class="w-14 bg-[#1c1917] border border-[#44403c] rounded-lg px-2 py-1 text-center text-[#e7e5e4] text-base font-mono focus:border-[#fbbf24] outline-none">
                                    <span class="text-[10px] text-[#a8a29e]">小時</span>
                                </div>
                                <div class="flex items-center gap-1">
                                    <input v-model.number="travelTimeForm.minutes" type="number" min="0" max="59" class="w-14 bg-[#1c1917] border border-[#44403c] rounded-lg px-2 py-1 text-center text-[#e7e5e4] text-base font-mono focus:border-[#fbbf24] outline-none">
                                    <span class="text-[10px] text-[#a8a29e]">分鐘</span>
                                </div>
                            </div>
                        </button>
                    </div>
                    
                    <button @click="saveTravelTime" class="w-full mt-6 bg-[#fbbf24] text-[#1c1917] font-bold py-3 rounded-xl shadow-lg active:scale-95 transition">確定修改</button>
                </div>
            </div>
        </transition>

        <!-- New: Start Time Edit Modal -->
        <transition name="modal">
            <div v-if="showTimeEditModal" class="fixed inset-0 z-[200] flex items-center justify-center pointer-events-none">
                <div @click="showTimeEditModal = false" class="absolute inset-0 bg-black/60 backdrop-blur-sm pointer-events-auto transition-opacity duration-300"></div>
                <!-- 修改：寬度改為 w-64，padding 改為 p-5，移除標題，讓畫面更簡潔 -->
                <div class="relative bg-[#292524] w-auto p-6 rounded-3xl border border-[#44403c] pointer-events-auto shadow-2xl flex flex-col gap-5 items-center">
                    
                    <!-- 修改：改為分離式輸入框 (小時 : 分鐘) -->
                    <div class="flex items-center gap-2">
                        <div class="flex flex-col items-center">
                            <!-- 修改：加入 @input="validateTimeInput('hour')" 進行防呆 -->
                            <input v-model="editingHours" @input="validateTimeInput('hour')" type="number" min="0" max="23" class="time-part-input" placeholder="09" @focus="$event.target.select()">
                            <span class="text-[10px] text-[#a8a29e] mt-1 font-bold tracking-wider">HOUR</span>
                        </div>
                        
                        <span class="text-3xl font-bold text-[#57534e] pb-4">:</span>
                        
                        <div class="flex flex-col items-center">
                            <!-- 修改：加入 @input="validateTimeInput('minute')" 進行防呆 -->
                            <input v-model="editingMinutes" @input="validateTimeInput('minute')" type="number" min="0" max="59" class="time-part-input" placeholder="00" @focus="$event.target.select()">
                            <span class="text-[10px] text-[#a8a29e] mt-1 font-bold tracking-wider">MIN</span>
                        </div>
                    </div>
                    
                    <button @click="saveTime" class="w-full bg-[#fbbf24] text-[#1c1917] font-bold py-3 rounded-xl shadow-lg active:scale-95 transition border-b-[4px] border-[#b45309] active:border-b-0 active:translate-y-[4px]">
                        確定
                    </button>
                </div>
            </div>
        </transition>

        <!-- Expense Modal (略，保持不變) -->
        <transition name="modal">
            <div v-if="showExpenseModal" class="fixed inset-0 z-[200] flex items-center justify-center pointer-events-none">
                <div @click="showExpenseModal = false" class="absolute inset-0 bg-black/60 backdrop-blur-sm pointer-events-auto transition-opacity duration-300"></div>
                <div class="modal-content relative bg-[#292524] w-full max-w-sm mx-6 rounded-3xl p-5 shadow-2xl border border-[#44403c] pointer-events-auto flex flex-col">
                    <button @click="showExpenseModal = false" class="absolute top-4 right-4 text-[#78716c] hover:text-[#e7e5e4] z-10"><i class="fa-solid fa-xmark text-xl"></i></button>
                    <div class="space-y-2 mt-4">
                        <div class="flex gap-2">
                            <div class="w-1/2"><label class="text-[10px] text-[#a8a29e] font-bold tracking-widest block mb-1">類別</label><select v-model="expenseForm.category" class="w-full bg-[#1c1917] border border-[#44403c] rounded-xl px-3 py-2 text-[#e7e5e4] text-sm outline-none focus:border-[#fbbf24] fixed-height-input"><option value="food">飲食</option><option value="transport">交通</option><option value="hotel">住宿</option><option value="ticket">門票</option><option value="shopping">購物</option><option value="other">其他</option></select></div>
                            <div class="w-1/2"><label class="text-[10px] text-[#a8a29e] font-bold tracking-widest block mb-1">付款方式</label><select v-model="expenseForm.payment" class="w-full bg-[#1c1917] border border-[#44403c] rounded-xl px-3 py-2 text-[#e7e5e4] text-sm outline-none focus:border-[#fbbf24] fixed-height-input"><option value="現金">現金</option><option value="國泰">國泰</option><option value="台新">台新</option><option value="星展">星展</option></select></div>
                        </div>
                        <div class="flex gap-2 items-end">
                            <div class="w-1/2"><label class="text-[10px] text-[#a8a29e] font-bold tracking-widest block mb-1">項目名稱</label><input v-model="expenseForm.title" type="text" class="w-full bg-[#1c1917] border border-[#44403c] rounded-xl px-3 py-2 text-[#e7e5e4] outline-none focus:border-[#fbbf24] fixed-height-input" placeholder="輸入消費項目..."></div>
                            <div class="w-1/2"><label class="text-[10px] text-[#a8a29e] font-bold tracking-widest block mb-1">日期</label><input type="date" v-model="expenseForm.date" class="w-full bg-[#1c1917] border border-[#44403c] rounded-xl px-3 text-[#e7e5e4] text-sm outline-none focus:border-[#fbbf24] fixed-height-input appearance-none"></div>
                        </div>
                        <div class="relative"><label class="text-[10px] text-[#a8a29e] font-bold tracking-widest block mb-1">金額 (TWD)</label><input type="number" v-model.number="expenseForm.amountTWD" @input="onInputTwd" class="w-full bg-[#1c1917] border border-[#44403c] rounded-xl pl-4 pr-10 py-2 text-[#e7e5e4] font-mono outline-none focus:border-[#fbbf24]"><button @click="openCalculator('twd')" class="absolute right-3 bottom-2 text-[#fbbf24] p-1"><i class="fa-solid fa-calculator"></i></button></div>
                        <div class="relative"><label class="text-[10px] text-[#a8a29e] font-bold tracking-widest block mb-1">金額 ({{ currency.code }})</label><input type="number" v-model.number="expenseForm.amountForeign" @input="onInputForeign" class="w-full bg-[#1c1917] border border-[#44403c] rounded-xl pl-4 pr-10 py-2 text-[#e7e5e4] font-mono outline-none focus:border-[#fbbf24]"><button @click="openCalculator('foreign')" class="absolute right-3 bottom-2 text-[#fbbf24] p-1"><i class="fa-solid fa-calculator"></i></button></div>
                        <div><label class="text-[10px] text-[#a8a29e] font-bold tracking-widest block mb-1">備註</label><input v-model="expenseForm.notes" type="text" class="w-full bg-[#1c1917] border border-[#44403c] rounded-xl px-4 py-2 text-[#e7e5e4] text-sm outline-none focus:border-[#fbbf24]" placeholder="備註..."></div>
                    </div>
                    <div class="flex gap-4 mt-5"><button v-if="isEditingExpense" @click="confirmDeleteExpense(expenseForm)" class="w-1/3 bg-[#ef4444] text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition flex items-center justify-center gap-2 border border-red-600/30"><i class="fa-solid fa-trash text-xs"></i> 刪除</button><button @click="saveExpense" class="flex-1 bg-[#fbbf24] text-[#1c1917] font-bold py-3 rounded-xl shadow-lg active:scale-95 transition">{{ isEditingExpense ? '儲存修改' : '新增紀錄' }}</button></div>
                </div>
            </div>
        </transition>

        <!-- Flight Edit Modal (Updated) -->
        <transition name="modal">
            <div v-if="showFlightModal" class="fixed inset-0 z-[200] flex items-center justify-center pointer-events-none">
                <div @click="showFlightModal = false" class="absolute inset-0 bg-black/60 backdrop-blur-sm pointer-events-auto transition-opacity duration-300"></div>
                <div class="modal-content relative bg-[#292524] w-full max-w-sm mx-4 rounded-3xl p-6 shadow-2xl border border-[#44403c] pointer-events-auto transform transition-all duration-300">
                    <button @click="showFlightModal = false" class="absolute top-4 right-4 text-[#78716c] hover:text-[#e7e5e4] transition z-10"><i class="fa-solid fa-xmark text-lg"></i></button>
                    <!-- 修改：移除頂部空白 -->
                    <div class="space-y-4 mt-8">
                        <div class="flex gap-3">
                            <div class="w-1/2"><label class="text-xs text-[#a8a29e] font-bold tracking-widest block mb-1">出發機場</label><input v-model="flightForm.depAirport" type="text" class="w-full bg-[#1c1917] border border-[#44403c] rounded-xl px-3 py-2 text-[#e7e5e4] focus:outline-none focus:border-[#fbbf24] transition placeholder-[#57534e]" placeholder="例如: TPE"></div>
                            <div class="w-1/2"><label class="text-xs text-[#a8a29e] font-bold tracking-widest block mb-1">抵達機場</label><input v-model="flightForm.arrAirport" type="text" class="w-full bg-[#1c1917] border border-[#44403c] rounded-xl px-3 py-2 text-[#e7e5e4] focus:outline-none focus:border-[#fbbf24] transition placeholder-[#57534e]" placeholder="例如: NRT"></div>
                        </div>
                        <div><label class="text-xs text-[#a8a29e] font-bold tracking-widest block mb-1">航班編號</label><input v-model="flightForm.number" type="text" class="w-full bg-[#1c1917] border border-[#44403c] rounded-xl px-3 py-2 text-[#e7e5e4] focus:outline-none focus:border-[#fbbf24] transition placeholder-[#57534e]" placeholder="例如: CI 100"></div>
                        
                        <div class="flex gap-2">
                            <div class="w-[50%]">
                                <label class="text-xs text-[#a8a29e] font-bold tracking-widest block mb-1">出發時間</label>
                                <input v-model="flightForm.depTime" type="text" placeholder="例如: 10:30" class="w-full bg-[#1c1917] border border-[#44403c] rounded-xl px-3 py-2 text-[#e7e5e4] text-center text-sm outline-none focus:border-[#fbbf24] placeholder-[#57534e]">
                            </div>
                            <div class="w-[40%]">
                                <label class="text-xs text-[#a8a29e] font-bold tracking-widest block mb-1">抵達時間</label>
                                <input v-model="flightForm.arrTime" type="text" placeholder="例如: 14:30" class="w-full bg-[#1c1917] border border-[#44403c] rounded-xl px-3 py-2 text-[#e7e5e4] text-center text-sm outline-none focus:border-[#fbbf24] placeholder-[#57534e]">
                            </div>
                            <div class="w-[10%]">
                                <label class="text-xs text-[#a8a29e] font-bold tracking-widest block mb-1">&nbsp;</label>
                                <select v-model="flightForm.arrDayOffset" class="w-full bg-[#1c1917] border border-[#44403c] rounded-xl px-0 py-2 text-[#fbbf24] text-xs outline-none focus:border-[#fbbf24] text-center font-bold h-[38px]">
                                    <option :value="0">+0</option>
                                    <option :value="1">+1</option>
                                    <option :value="2">+2</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <button @click="saveFlight" class="w-full bg-[#fbbf24] border-b-[6px] border-[#b45309] text-[#1c1917] font-bold py-3 rounded-xl mt-6 hover:bg-[#f59e0b] active:border-b-0 active:translate-y-[6px] active:shadow-none transition-all shadow-lg flex items-center justify-center gap-2"><i v-if="isCalculatingFlight" class="fa-solid fa-spinner fa-spin"></i><span>{{ isCalculatingFlight ? '計算中...' : '儲存資訊' }}</span></button>
                </div>
            </div>
        </transition>

        <!-- Hotel Edit Modal -->
        <transition name="modal">
            <div v-if="showHotelModal" class="fixed inset-0 z-[200] flex items-center justify-center pointer-events-none">
                <div @click="showHotelModal = false" class="absolute inset-0 bg-black/60 backdrop-blur-sm pointer-events-auto transition-opacity duration-300"></div>
                <div class="modal-content relative bg-[#292524] w-full max-w-sm mx-4 rounded-3xl p-6 shadow-2xl border border-[#44403c] pointer-events-auto transform transition-all duration-300">
                    <button @click="showHotelModal = false" class="absolute top-4 right-4 text-[#78716c] hover:text-[#e7e5e4] transition z-10"><i class="fa-solid fa-xmark text-lg"></i></button>
                    <!-- 修改：移除頂部空白 -->
                    <div class="space-y-4 mt-8">
                        <div>
                            <label class="text-xs text-[#a8a29e] font-bold tracking-widest block mb-1">飯店名稱 (Hotel Name)</label>
                            <input v-model="hotelForm.name" type="text" class="w-full bg-[#1c1917] border border-[#44403c] rounded-xl px-3 py-2 text-[#e7e5e4] focus:outline-none focus:border-[#fbbf24] transition placeholder-[#57534e]" placeholder="輸入飯店名稱">
                        </div>
                        <div>
                            <label class="text-xs text-[#a8a29e] font-bold tracking-widest block mb-1">電話 (Phone)</label>
                            <input v-model="hotelForm.phone" type="text" class="w-full bg-[#1c1917] border border-[#44403c] rounded-xl px-3 py-2 text-[#e7e5e4] focus:outline-none focus:border-[#fbbf24] transition placeholder-[#57534e]" placeholder="輸入電話">
                        </div>
                        <div>
                            <label class="text-xs text-[#a8a29e] font-bold tracking-widest block mb-1">住址 (Address)</label>
                            <textarea v-model="hotelForm.address" rows="2" class="w-full bg-[#1c1917] border border-[#44403c] rounded-xl px-3 py-2 text-[#e7e5e4] focus:outline-none focus:border-[#fbbf24] transition placeholder-[#57534e]" placeholder="輸入地址"></textarea>
                        </div>
                    </div>
                    
                    <button @click="proceedToHotelMapConfirm" class="w-full bg-[#fbbf24] border-b-[6px] border-[#b45309] text-[#1c1917] font-bold py-3 rounded-xl mt-6 hover:bg-[#f59e0b] active:border-b-0 active:translate-y-[6px] active:shadow-none transition-all shadow-lg flex items-center justify-center gap-2">
                        <i class="fa-solid fa-map-location-dot"></i>
                        <span>下一步：定位確認</span>
                    </button>
                </div>
            </div>
        </transition>

        <!-- Hotel Map Confirmation Modal -->
        <transition name="modal">
            <div v-if="showHotelMapModal" class="fixed inset-0 z-[200] flex items-center justify-center pointer-events-none">
                <div class="absolute inset-0 bg-black/80 backdrop-blur-sm pointer-events-auto"></div>
                <div class="relative bg-[#1c1917] w-full h-full sm:max-w-md sm:h-[80vh] sm:rounded-3xl shadow-2xl flex flex-col pointer-events-auto overflow-hidden border border-[#44403c]">
                    <div class="absolute top-4 left-4 right-4 z-[1000] flex justify-between items-start pointer-events-none">
                        <div class="bg-[#292524]/90 backdrop-blur px-4 py-2 rounded-xl border border-[#44403c] shadow-lg pointer-events-auto">
                            <h3 class="text-[#fbbf24] font-bold text-sm">確認飯店位置</h3>
                            <p class="text-[10px] text-[#a8a29e]">移動圖釘以修正位置</p>
                        </div>
                        <button @click="showHotelMapModal = false; showHotelModal = true" class="w-10 h-10 rounded-full bg-[#292524] text-[#e7e5e4] flex items-center justify-center shadow-lg border border-[#44403c] pointer-events-auto"><i class="fa-solid fa-arrow-left"></i></button>
                    </div>
                    
                    <div id="hotel-confirm-map" class="flex-1 w-full bg-[#292524] relative z-0"></div>
                    
                    <!-- Fixed Bottom Confirm Button (Ensures Visibility) -->
                    <div class="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-black/90 to-transparent z-[1001] pointer-events-none flex justify-center pb-8">
                        <button @click="confirmHotelLocation" class="w-full max-w-sm bg-[#fbbf24] border-b-[6px] border-[#b45309] text-[#1c1917] font-bold py-4 rounded-xl shadow-[0_0_20px_rgba(251,191,36,0.4)] active:border-b-0 active:translate-y-[6px] transition-all pointer-events-auto mx-4">
                            確認位置並儲存
                        </button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- Checklist Add Modal -->
        <transition name="modal">
            <div v-if="showAddChecklistModal" class="fixed inset-0 z-[200] flex items-center justify-center pointer-events-none">
                <div @click="showAddChecklistModal = false" class="absolute inset-0 bg-black/60 backdrop-blur-sm pointer-events-auto transition-opacity duration-300"></div>
                <div class="relative bg-[#292524] w-full max-w-xs mx-4 rounded-3xl p-6 shadow-2xl border border-[#44403c] text-center pointer-events-auto transform transition-all duration-300 scale-100">
                    <button @click="showAddChecklistModal = false" class="absolute top-4 right-4 text-[#78716c] hover:text-[#e7e5e4] transition z-10"><i class="fa-solid fa-xmark text-lg"></i></button>
                    <!-- 修改：移除頂部空白 -->
                    <div class="h-4"></div>
                    <label class="text-xs text-[#a8a29e] font-bold tracking-widest block mb-1 text-left">Item</label>
                    <input v-model="newChecklistItemName" type="text" class="w-full bg-[#1c1917] border border-[#44403c] rounded-xl px-4 py-3 text-[#e7e5e4] placeholder-[#57534e] focus:outline-none focus:border-[#fbbf24] transition mb-6" placeholder="輸入項目名稱...">
                    <div class="flex gap-3 justify-center">
                        <button @click="confirmAddChecklistItem" class="px-6 py-2 rounded-xl bg-[#fbbf24] text-[#1c1917] border border-[#b45309] text-sm font-bold shadow-lg hover:bg-[#f59e0b] transition w-full">新增</button>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="modal"><div v-if="showCalculator" class="fixed inset-0 z-[200] flex items-center justify-center pointer-events-none"><div @click="showCalculator = false" class="absolute inset-0 bg-black/60 pointer-events-auto"></div><div class="modal-content bg-[#1c1917] w-full max-w-xs rounded-3xl p-5 border border-[#44403c] pointer-events-auto shadow-2xl z-10"><div class="bg-[#292524] p-4 rounded-xl text-right text-3xl font-mono text-[#e7e5e4] mb-4 border border-[#44403c] h-16 flex items-center justify-end overflow-hidden">{{ calcDisplay }}</div><div class="grid grid-cols-4 gap-3"><button @click="calcAppend('7')" class="calc-btn">7</button><button @click="calcAppend('8')" class="calc-btn">8</button><button @click="calcAppend('9')" class="calc-btn">9</button><button @click="calcOp('/')" class="calc-btn operator">÷</button><button @click="calcAppend('4')" class="calc-btn">4</button><button @click="calcAppend('5')" class="calc-btn">5</button><button @click="calcAppend('6')" class="calc-btn">6</button><button @click="calcOp('*')" class="calc-btn operator">×</button><button @click="calcAppend('1')" class="calc-btn">1</button><button @click="calcAppend('2')" class="calc-btn">2</button><button @click="calcAppend('3')" class="calc-btn">3</button><button @click="calcOp('-')" class="calc-btn operator">-</button><button @click="calcClear()" class="calc-btn text-red-400">C</button><button @click="calcAppend('0')" class="calc-btn">0</button><button @click="calcConfirm()" class="calc-btn equals">=</button><button @click="calcOp('+')" class="calc-btn operator">+</button></div></div></div></transition>
        
        <!-- Add Trip Modal -->
        <transition name="modal">
            <div v-if="showAddTripModal" class="fixed inset-0 z-[200] flex items-center justify-center pointer-events-none">
                <div @click="showAddTripModal = false" class="absolute inset-0 bg-black/60 backdrop-blur-sm pointer-events-auto transition-opacity duration-300"></div>
                <div class="modal-content relative bg-[#292524] w-full max-w-sm mx-4 sm:mb-0 mb-6 rounded-3xl p-6 shadow-2xl border border-[#44403c] pointer-events-auto transform transition-all duration-300">
                    <div class="flex justify-end items-center mb-0"><button @click="showAddTripModal = false" class="text-[#78716c] hover:text-[#e7e5e4] transition"><i class="fa-solid fa-xmark text-lg"></i></button></div>
                    <!-- 修改：移除頂部空白 -->
                    <div class="space-y-4">
                        <div><label class="text-xs text-[#a8a29e] font-bold tracking-widest block mb-2">Title</label><input v-model="newTrip.title" type="text" placeholder="例如: Tokyo Trip" class="w-full bg-[#1c1917] border border-[#44403c] rounded-xl px-4 py-3 text-[#e7e5e4] placeholder-[#57534e] focus:outline-none focus:border-[#fbbf24] transition"></div>
                        <div class="flex gap-3">
                            <div class="w-1/2">
                                <label class="text-xs text-[#a8a29e] font-bold tracking-widest block mb-2">Start Date</label>
                                <input v-model="newTrip.start" type="date" onkeydown="return false" 
                                       class="w-full bg-[#1c1917] border border-[#44403c] rounded-xl px-3 py-3 focus:outline-none focus:border-[#fbbf24] transition text-xs cursor-pointer caret-transparent"
                                       :class="newTrip.start ? 'text-[#e7e5e4]' : 'text-transparent'">
                            </div>
                            <div class="w-1/2">
                                <label class="text-xs text-[#a8a29e] font-bold tracking-widest block mb-2">End Date</label>
                                <input v-model="newTrip.end" type="date" onkeydown="return false"
                                       class="w-full bg-[#1c1917] border border-[#44403c] rounded-xl px-3 py-3 focus:outline-none focus:border-[#fbbf24] transition text-xs cursor-pointer caret-transparent"
                                       :class="newTrip.end ? 'text-[#e7e5e4]' : 'text-transparent'">
                            </div>
                        </div>
                        <div>
                            <label class="text-xs text-[#a8a29e] font-bold tracking-widest block mb-2">封面圖片</label>
                            
                            <!-- New Visual Image Selector -->
                            <div class="relative h-48 bg-[#1c1917] rounded-xl border border-[#44403c] overflow-hidden flex items-center justify-center group cursor-pointer hover:border-[#fbbf24] transition border-dashed" @click="triggerFileInput('add-trip-image-input')">
                                <img v-if="newTrip.image" :src="newTrip.image" class="w-full h-full object-cover">
                                <div v-else class="text-[#57534e] flex flex-col items-center">
                                    <i class="fa-regular fa-image text-2xl mb-2"></i>
                                    <span class="text-[10px]">點擊選擇封面圖片</span>
                                </div>
                                <input type="file" id="add-trip-image-input" class="hidden" accept="image/*" @change="handleTripImageUpload">
                            </div>
                        </div>
                    </div>
                    <!-- Yellow Button -->
                    <button @click="saveNewTrip" class="w-full bg-[#fbbf24] border-b-[6px] border-[#b45309] text-[#1c1917] font-bold py-4 rounded-xl mt-8 hover:bg-[#f59e0b] active:border-b-0 active:translate-y-[6px] active:shadow-none transition-all shadow-lg">建立旅程</button>
                </div>
            </div>
        </transition>

        <transition name="modal">
            <div v-if="showEditTripModal" class="fixed inset-0 z-[200] flex items-center justify-center pointer-events-none">
                <div @click="showEditTripModal = false" class="absolute inset-0 bg-black/60 backdrop-blur-sm pointer-events-auto transition-opacity duration-300"></div>
                <div class="modal-content relative bg-[#292524] w-full max-w-sm mx-4 sm:mb-0 mb-6 rounded-3xl p-6 shadow-2xl border border-[#44403c] pointer-events-auto transform transition-all duration-300">
                    <div class="flex justify-end items-center mb-0"><button @click="showEditTripModal = false" class="text-[#78716c] hover:text-[#e7e5e4] transition"><i class="fa-solid fa-xmark text-lg"></i></button></div>
                    <!-- 修改：移除頂部空白 -->
                    <div class="space-y-4">
                        <div><label class="text-xs text-[#a8a29e] font-bold tracking-widest block mb-2">Title</label><input v-model="editingTrip.title" type="text" class="w-full bg-[#1c1917] border border-[#44403c] rounded-xl px-4 py-3 text-[#e7e5e4] placeholder-[#57534e] focus:outline-none focus:border-[#fbbf24] transition"></div>
                        <div class="flex gap-3">
                            <div class="w-1/2">
                                <label class="text-xs text-[#a8a29e] font-bold tracking-widest block mb-2">Start Date</label>
                                <input v-model="editingTrip.start" type="date" onkeydown="return false"
                                       class="w-full bg-[#1c1917] border border-[#44403c] rounded-xl px-3 py-3 focus:outline-none focus:border-[#fbbf24] transition text-xs cursor-pointer caret-transparent"
                                       :class="editingTrip.start ? 'text-[#e7e5e4]' : 'text-transparent'">
                            </div>
                            <div class="w-1/2">
                                <label class="text-xs text-[#a8a29e] font-bold tracking-widest block mb-2">End Date</label>
                                <input v-model="editingTrip.end" type="date" onkeydown="return false"
                                       class="w-full bg-[#1c1917] border border-[#44403c] rounded-xl px-3 py-3 focus:outline-none focus:border-[#fbbf24] transition text-xs cursor-pointer caret-transparent"
                                       :class="editingTrip.end ? 'text-[#e7e5e4]' : 'text-transparent'">
                            </div>
                        </div>
                        <div><label class="text-xs text-[#a8a29e] font-bold tracking-widest block mb-2">封面圖片</label><input v-model="editingTrip.image" type="text" class="w-full bg-[#1c1917] border border-[#44403c] rounded-xl px-4 py-3 text-[#e7e5e4] placeholder-[#57534e] focus:outline-none focus:border-[#fbbf24] transition"></div>
                    </div>
                    <!-- Update Colors: Delete(Red), Save(Yellow) -->
                    <div class="mt-8 flex gap-4">
                        <button @click="deleteTrip" class="w-1/3 rounded-full bg-[#ef4444] border-b-[6px] border-[#b91c1c] text-white font-bold py-3 shadow-xl active:border-b-0 active:translate-y-[6px] active:shadow-none transition-all duration-100 flex items-center justify-center gap-2 hover:bg-[#dc2626]">刪除</button>
                        <button @click="saveEditedTrip" class="w-2/3 rounded-full bg-[#fbbf24] border-b-[6px] border-[#b45309] text-[#1c1917] font-bold py-3 shadow-xl active:border-b-0 active:translate-y-[6px] active:shadow-none transition-all duration-100 hover:bg-[#f59e0b]">儲存修改</button>
                    </div>
                </div>
            </div>
        </transition>
        <transition name="modal"><div v-if="showDeleteConfirmModal" class="fixed inset-0 z-[200] flex items-center justify-center pointer-events-none"><div @click="showDeleteConfirmModal = false" class="absolute inset-0 bg-black/70 backdrop-blur-sm pointer-events-auto transition-opacity duration-300"></div><div class="relative bg-[#292524] w-full max-w-xs mx-4 rounded-3xl p-6 shadow-2xl border border-[#44403c] text-center pointer-events-auto transform transition-all duration-300 scale-100"><h3 class="text-lg font-bold text-[#e7e5e4] mb-2">確定要刪除嗎？</h3><p class="text-xs text-[#a8a29e] mb-6">刪除後無法復原。</p><div class="flex gap-3 justify-center"><button @click="showDeleteConfirmModal = false" class="px-6 py-2 rounded-xl bg-[#a8a29e] text-[#1c1917] border border-[#57534e] text-sm font-bold shadow-md hover:bg-[#d6d3d1] transition">取消</button><button @click="confirmDelete" class="px-6 py-2 rounded-xl bg-[#ef4444] text-white text-sm font-bold shadow-lg hover:bg-[#dc2626] transition">確定刪除</button></div></div></div></transition>
        
        <!-- Delete Expense Confirm Modal -->
        <transition name="modal"><div v-if="showDeleteExpenseConfirmModal" class="fixed inset-0 z-[200] flex items-center justify-center pointer-events-none"><div @click="showDeleteExpenseConfirmModal = false" class="absolute inset-0 bg-black/70 backdrop-blur-sm pointer-events-auto transition-opacity duration-300"></div><div class="relative bg-[#292524] w-full max-w-xs mx-4 rounded-3xl p-6 shadow-2xl border border-[#44403c] text-center pointer-events-auto transform transition-all duration-300 scale-100"><h3 class="text-lg font-bold text-[#e7e5e4] mb-2">確定要刪除這筆消費嗎？</h3><p class="text-xs text-[#a8a29e] mb-6">刪除後無法復原。</p><div class="flex gap-3 justify-center"><button @click="showDeleteExpenseConfirmModal = false" class="px-6 py-2 rounded-xl bg-[#a8a29e] text-[#1c1917] border border-[#57534e] text-sm font-bold shadow-md hover:bg-[#d6d3d1] transition">取消</button><button @click="executeDeleteExpense" class="px-6 py-2 rounded-xl bg-[#ef4444] text-white text-sm font-bold shadow-lg hover:bg-[#dc2626] transition">確定刪除</button></div></div></div></transition>
        
        <!-- 行程刪除確認視窗 -->
        <transition name="modal"><div v-if="showDeleteItemConfirmModal" class="fixed inset-0 z-[200] flex items-center justify-center pointer-events-none"><div @click="showDeleteItemConfirmModal = false" class="absolute inset-0 bg-black/70 backdrop-blur-sm pointer-events-auto transition-opacity duration-300"></div><div class="relative bg-[#292524] w-full max-w-xs mx-4 rounded-3xl p-6 shadow-2xl border border-[#44403c] text-center pointer-events-auto transform transition-all duration-300 scale-100"><h3 class="text-lg font-bold text-[#e7e5e4] mb-2">確定要刪除行程嗎？</h3><p class="text-xs text-[#a8a29e] mb-6">刪除後無法復原。</p><div class="flex gap-3 justify-center"><button @click="showDeleteItemConfirmModal = false" class="px-6 py-2 rounded-xl bg-[#a8a29e] text-[#1c1917] border border-[#57534e] text-sm font-bold shadow-md hover:bg-[#d6d3d1] transition">取消</button><button @click="executeDeleteItem" class="px-6 py-2 rounded-xl bg-[#ef4444] text-white text-sm font-bold shadow-lg hover:bg-[#dc2626] transition">確定</button></div></div></div></transition>

        <!-- Delete Checklist Item Confirm Modal -->
        <transition name="modal"><div v-if="showDeleteChecklistConfirmModal" class="fixed inset-0 z-[200] flex items-center justify-center pointer-events-none"><div @click="showDeleteChecklistConfirmModal = false" class="absolute inset-0 bg-black/70 backdrop-blur-sm pointer-events-auto transition-opacity duration-300"></div><div class="relative bg-[#292524] w-full max-w-xs mx-4 rounded-3xl p-6 shadow-2xl border border-[#44403c] text-center pointer-events-auto transform transition-all duration-300 scale-100"><h3 class="text-lg font-bold text-[#e7e5e4] mb-2">刪除項目？</h3><p class="text-xs text-[#a8a29e] mb-6">確定要刪除此檢查項目嗎？</p><div class="flex gap-3 justify-center"><button @click="showDeleteChecklistConfirmModal = false" class="px-6 py-2 rounded-xl bg-[#a8a29e] text-[#1c1917] border border-[#57534e] text-sm font-bold shadow-md hover:bg-[#d6d3d1] transition">取消</button><button @click="executeDeleteChecklistItem" class="px-6 py-2 rounded-xl bg-[#ef4444] text-white text-sm font-bold shadow-lg hover:bg-[#dc2626] transition">確定</button></div></div></div></transition>

        <!-- Item Map Confirmation Modal -->
        <transition name="modal">
            <div v-if="showMapConfirmModal" class="fixed inset-0 z-[200] flex items-center justify-center pointer-events-none">
                <div class="absolute inset-0 bg-black/80 backdrop-blur-sm pointer-events-auto"></div>
                <div class="relative bg-[#1c1917] w-full h-full sm:max-w-md sm:h-[80vh] sm:rounded-3xl shadow-2xl flex flex-col pointer-events-auto overflow-hidden border border-[#44403c]">
                    <div class="absolute top-4 left-4 right-4 z-[1000] flex justify-between items-start pointer-events-none">
                        <div class="bg-[#292524]/90 backdrop-blur px-4 py-2 rounded-xl border border-[#44403c] shadow-lg pointer-events-auto">
                            <h3 class="text-[#fbbf24] font-bold text-sm">{{ itemForm.title || '確認位置' }}</h3>
                            <p class="text-[10px] text-[#a8a29e]">移動圖釘以修正位置</p>
                        </div>
                        <button @click="showMapConfirmModal = false; showItemModal = true" class="w-10 h-10 rounded-full bg-[#292524] text-[#e7e5e4] flex items-center justify-center shadow-lg border border-[#44403c] pointer-events-auto"><i class="fa-solid fa-arrow-left"></i></button>
                    </div>
                    <div id="item-confirm-map" class="flex-1 w-full bg-[#292524] relative z-0"></div>
                    <div class="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-black/90 to-transparent z-[1001] pointer-events-none flex justify-center pb-8">
                        <button @click="saveItemWithLocation" class="w-full max-w-sm bg-[#fbbf24] border-b-[6px] border-[#b45309] text-[#1c1917] font-bold py-4 rounded-xl shadow-[0_0_20px_rgba(251,191,36,0.4)] active:border-b-0 active:translate-y-[6px] transition-all pointer-events-auto mx-4">確認位置並加入</button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- Itinerary Modal -->
        <transition name="modal">
            <div v-if="showItemModal" class="fixed inset-0 z-[200] flex items-center justify-center pointer-events-none">
                <div @click="showItemModal = false" class="absolute inset-0 bg-black/60 backdrop-blur-sm pointer-events-auto transition-opacity duration-300"></div>
                <div class="modal-content relative bg-[#292524] w-full max-w-sm mx-4 rounded-3xl p-6 shadow-2xl border border-[#44403c] pointer-events-auto transform transition-all duration-300">
                    <button @click="showItemModal = false" class="absolute top-4 right-4 text-[#78716c] hover:text-[#e7e5e4] transition z-10"><i class="fa-solid fa-xmark text-lg"></i></button>
                    
                    <!-- 修改：移除頂部佔位 div，新增類型選擇 Icon 區 -->
                    <div class="space-y-4 mt-8">
                        
                        <!-- 類型選擇 Icons -->
                        <div class="flex gap-4 justify-center mb-6">
                            <button v-for="t in itemTypes" :key="t.id" 
                                    @click="itemForm.type = t.id"
                                    class="w-12 h-12 rounded-full flex flex-col items-center justify-center border transition-all duration-200"
                                    :class="itemForm.type === t.id ? 'bg-[#fbbf24] border-[#fbbf24] text-[#1c1917] scale-110 shadow-[0_0_15px_rgba(251,191,36,0.4)]' : 'bg-[#1c1917] border-[#44403c] text-[#78716c] hover:border-[#a8a29e] hover:text-[#a8a29e]'">
                                <i :class="['fa-solid', t.icon, 'text-lg']"></i>
                                <span class="text-[8px] font-bold mt-0.5 leading-none">{{ t.label }}</span>
                            </button>
                        </div>

                        <div>
                            <label class="text-xs text-[#a8a29e] font-bold tracking-widest block mb-1">地點 (Location)</label>
                            <input v-model="itemForm.title" type="text" class="w-full bg-[#1c1917] border border-[#44403c] rounded-xl px-3 py-2 text-[#e7e5e4] focus:outline-none focus:border-[#fbbf24] transition placeholder-[#57534e]" placeholder="地點名稱...">
                        </div>

                        <!-- 修改：移除原本在此處的「時間 (Time)」欄位 -->
                        
                        <div class="flex gap-3">
                            <div class="flex-1">
                                <label class="text-xs text-[#a8a29e] font-bold tracking-widest block mb-1">停留時間 (Duration)</label>
                                <div class="flex gap-2 items-center">
                                    <!-- 修改：小時欄位加入 @input="validateDurationInput('hr')" 做防呆 (0-23) -->
                                    <input v-model.number="itemForm.durationHr" 
                                           @input="validateDurationInput('hr')"
                                           type="number" min="0" max="23" 
                                           class="w-full bg-[#1c1917] border border-[#44403c] rounded-xl px-2 py-2 text-[#e7e5e4] text-center focus:outline-none focus:border-[#fbbf24]" 
                                           placeholder="Hr">
                                    
                                    <span class="text-[#57534e] text-xs font-bold">:</span>
                                    
                                    <!-- 修改：分鐘欄位加入 @input="validateDurationInput('min')" 做防呆 (0-59) -->
                                    <input v-model.number="itemForm.durationMin" 
                                           @input="validateDurationInput('min')"
                                           type="number" min="0" max="59" 
                                           class="w-full bg-[#1c1917] border border-[#44403c] rounded-xl px-2 py-2 text-[#e7e5e4] text-center focus:outline-none focus:border-[#fbbf24]" 
                                           placeholder="Min">
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex gap-2 justify-center py-2">
                            <button v-for="mode in ['car', 'bus', 'walking']" :key="mode" @click="itemForm.travelMode = mode" class="w-10 h-10 rounded-full flex items-center justify-center border transition-all" :class="itemForm.travelMode === mode ? 'bg-[#fbbf24] border-[#fbbf24] text-[#1c1917] scale-110 shadow-lg' : 'bg-[#1c1917] border-[#44403c] text-[#78716c] hover:border-[#a8a29e]'">
                                <i :class="getTravelIcon(mode)"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex gap-4 mt-6">
                        <!-- 修改：刪除按鈕樣式改為與消費視窗一致 (紅色、有文字) -->
                        <button v-if="isEditingItem" @click="confirmDeleteItem" class="w-1/3 bg-[#ef4444] text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition flex items-center justify-center gap-2 border border-red-600/30">
                            <i class="fa-solid fa-trash text-xs"></i> 刪除
                        </button>
                        
                        <!-- 修改：確認按鈕文字改為「下一步：定位確認」，功能維持觸發 proceedToMapConfirm (下方 JS 會更新此函數邏輯) -->
                        <button @click="proceedToMapConfirm" class="flex-1 bg-[#fbbf24] border-b-[6px] border-[#b45309] text-[#1c1917] font-bold py-3 rounded-xl hover:bg-[#f59e0b] active:border-b-0 active:translate-y-[6px] active:shadow-none transition-all shadow-lg flex items-center justify-center gap-2">
                            <i class="fa-solid fa-map-location-dot"></i>
                            <span>下一步：定位確認</span>
                        </button>
                    </div>
                </div>
            </div>
        </transition>

    </div>

    <!-- Firebase SDK (ES Modules) -->
    <script type="module">
        import { createApp, ref, nextTick, onMounted, onUnmounted, computed, watch } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref as dbRef, set, onValue, push, child, remove, update, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAhSqxv2dcCehxuEFA3knWDfEco8dzln1w",
            authDomain: "travel-app-97b9b.firebaseapp.com",
            databaseURL: "https://travel-app-97b9b-default-rtdb.firebaseio.com",
            projectId: "travel-app-97b9b",
            storageBucket: "travel-app-97b9b.firebasestorage.app",
            messagingSenderId: "237738225198",
            appId: "1:237738225198:web:48df8bff249558e435f9bf",
            measurementId: "G-DBX1X4XVL7"
        };

        // Initialize Firebase
        const firebaseApp = initializeApp(firebaseConfig);
        const db = getDatabase(firebaseApp);

        createApp({
            setup() {
                // 資料載入 Helper (for LocalStorage)
                const loadStorage = (key, defaultVal) => {
                    const stored = localStorage.getItem(key);
                    return stored ? JSON.parse(stored) : defaultVal;
                };

                const currentPage = ref('home'); 
                const currentTab = ref('itinerary');
                const currentView = ref('list'); 
                const mapInstance = ref(null);
                const confirmMapInstance = ref(null);
                const confirmMarker = ref(null);
                const selectedItem = ref(null);
                const weatherLoading = ref(false);
                
                let sortableInstance = null;
                let tripSortableInstance = null;

                // Modals
                const showAddTripModal = ref(false);
                const showEditTripModal = ref(false);
                const showDeleteConfirmModal = ref(false);
                const showDeleteItemConfirmModal = ref(false);
                const showMapConfirmModal = ref(false);
                const showItemModal = ref(false);
                const showHotelModal = ref(false); 
                const showHotelMapModal = ref(false); 
                const showAddChecklistModal = ref(false); 
                const showDeleteChecklistConfirmModal = ref(false); 
                const showFlightModal = ref(false);
                const showTravelTimeModal = ref(false);
                const showTimeEditModal = ref(false);

                // Flight
                const editingFlightType = ref('out');
                const currentFlightType = ref('out');
                const flightForm = ref({ depAirport: '', arrAirport: '', number: '', depTime: '', arrTime: '', arrDayOffset: 0, dep: '', arr: '', duration: '' });
                const isCalculatingFlight = ref(false);
                
                // Travel Time Editing
                const editingTravelItem = ref(null);
                const travelTimeForm = ref({ type: 'auto', minutes: 0, hours: 0, mode: 'car' });
                
                // Start Time Editing
                const editingHours = ref('');
                const editingMinutes = ref('');
                let editingItemRef = null;

                // Validate Time Inputs
                const validateTimeInput = (type) => {
                    if (type === 'hour') {
                        if (editingHours.value === '' || editingHours.value === null) return;
                        let val = parseInt(editingHours.value);
                        if (val > 23) editingHours.value = 23;
                        if (val < 0) editingHours.value = 0;
                    } else if (type === 'minute') {
                        if (editingMinutes.value === '' || editingMinutes.value === null) return;
                        let val = parseInt(editingMinutes.value);
                        if (val > 59) editingMinutes.value = 59;
                        if (val < 0) editingMinutes.value = 0;
                    }
                };

                const validateDurationInput = (type) => {
                    if (type === 'hr') {
                        if (itemForm.value.durationHr === '' || itemForm.value.durationHr === null) return;
                        let val = parseInt(itemForm.value.durationHr);
                        if (val > 23) itemForm.value.durationHr = 23;
                        if (val < 0) itemForm.value.durationHr = 0;
                    } else if (type === 'min') {
                        if (itemForm.value.durationMin === '' || itemForm.value.durationMin === null) return;
                        let val = parseInt(itemForm.value.durationMin);
                        if (val > 59) itemForm.value.durationMin = 59;
                        if (val < 0) itemForm.value.durationMin = 0;
                    }
                };

                const timeSelectOptions = {
                    hours: Array.from({length: 24}, (_, i) => String(i).padStart(2, '0')),
                    minutes: Array.from({length: 12}, (_, i) => String(i * 5).padStart(2, '0'))
                };

                const newTrip = ref({ title: '', start: '', end: '', image: null });
                const editingTrip = ref({ id: '', title: '', start: '', end: '', image: '' });
                const hotelForm = ref({ name: '', phone: '', address: '', lat: 0, lng: 0 });
                const hotelMapInstance = ref(null);
                const hotelMapMarker = ref(null);

                const newChecklistItemName = ref('');
                const targetChecklistCategory = ref('');
                
                const timeOptions = [];
                for (let h = 0; h < 24; h++) { const hh = String(h).padStart(2, '0'); timeOptions.push(`${hh}:00`); timeOptions.push(`${hh}:30`); }

                const itemForm = ref({ id: '', title: '', type: 'spot', arrivalTime: '10:00', durationHr: 1, durationMin: 30, lat: -8.5069, lng: 115.2625, openingHours: '', notes: '', travelMode: 'car' });
                const isEditingItem = ref(false);
                
                const itemTypes = [
                    { id: 'spot', icon: 'fa-location-dot', label: '景點' },
                    { id: 'food', icon: 'fa-utensils', label: '餐廳' },
                    { id: 'hotel', icon: 'fa-hotel', label: '住宿' },
                    { id: 'airport', icon: 'fa-plane', label: '機場' }
                ];

                // --- 花費頁面資料 ---
                const showCurrencyModal = ref(false);
                const showExpenseModal = ref(false);
                const showCalculator = ref(false);
                
                // Currency remains in LocalStorage as per request (since it's a global preference/cache)
                const currency = ref(loadStorage('myTrip_currency', { code: 'JPY', rate: 0.22 }));
                const exchangeRates = ref({ 'JPY': 0.22, 'USD': 32.5, 'KRW': 0.024, 'EUR': 35.1, 'THB': 0.9, 'IDR': 0.002 });
                
                // === FIREBASE DATA REFS ===
                // Initialize as empty/default, populated by connectFirebase()
                const expenses = ref([]);
                const itinerary = ref([]);
                
                const defaultInfo = {
                    flight: { 
                        out: { depAirport: '', arrAirport: '', number: '', dep: '', arr: '', duration: '', arrDayOffset: 0, currentUser: 'user1' }, 
                        in: { depAirport: '', arrAirport: '', number: '', dep: '', arr: '', duration: '', arrDayOffset: 0, currentUser: 'user1' }, 
                        currentUser: 'user1', images: { user1: null, user2: null } 
                    },
                    hotel: { 
                        currentIndex: 0,
                        list: [
                            { name: '', phone: '', address: '', lat: -8.5069, lng: 115.2625 },
                            { name: '', phone: '', address: '', lat: -8.5069, lng: 115.2625 },
                            { name: '', phone: '', address: '', lat: -8.5069, lng: 115.2625 },
                            { name: '', phone: '', address: '', lat: -8.5069, lng: 115.2625 },
                            { name: '', phone: '', address: '', lat: -8.5069, lng: 115.2625 }
                        ]
                    },
                    visa: { currentUser: 'user1', images: { user1: null, user2: null } },
                    checklist: {
                        '重要項目': [{name: '護照', checked: false}, {name: '外幣', checked: false}],
                        '電子產品': [{name: '手機', checked: false}, {name: '相機', checked: false}, {name: 'Gopro', checked: false}, {name: 'Chromecast', checked: false}, {name: '萬國充電器', checked: false}, {name: '充電線', checked: false}],
                        '雜項': [{name: '衣物', checked: false}, {name: '牙刷', checked: false}, {name: '衛生紙', checked: false}, {name: '藥品', checked: false}]
                    }
                };
                // Reactive Info object, structure merged on load
                const info = ref(JSON.parse(JSON.stringify(defaultInfo)));

                const expenseForm = ref({ id: null, category: 'food', title: '', amountTWD: '', amountForeign: '', date: new Date().toISOString().split('T')[0], payment: '現金', notes: '' });
                
                const activeExpenseMenuId = ref(null);
                const isEditingExpense = ref(false);
                const deleteExpenseId = ref(null);
                const showDeleteExpenseConfirmModal = ref(false);

                const toggleExpenseMenu = (id) => {
                    if (activeExpenseMenuId.value === id) {
                        activeExpenseMenuId.value = null;
                    } else {
                        activeExpenseMenuId.value = id;
                    }
                };

                const editExpense = (exp) => {
                    activeExpenseMenuId.value = null;
                    isEditingExpense.value = true;
                    expenseForm.value = JSON.parse(JSON.stringify(exp));
                    showExpenseModal.value = true;
                };

                const confirmDeleteExpense = (exp) => {
                    activeExpenseMenuId.value = null;
                    deleteExpenseId.value = exp.id;
                    showDeleteExpenseConfirmModal.value = true;
                };

                const executeDeleteExpense = () => {
                    if (deleteExpenseId.value) {
                        const index = expenses.value.findIndex(e => e.id === deleteExpenseId.value);
                        if (index !== -1) {
                            expenses.value.splice(index, 1);
                        }
                    }
                    showDeleteExpenseConfirmModal.value = false;
                    deleteExpenseId.value = null;
                    showExpenseModal.value = false;
                };

                const expenseFilter = ref('all');
                const expenseCategories = [
                    { key: 'all', label: 'All' },
                    { key: 'food', label: '飲食' },
                    { key: 'transport', label: '交通' },
                    { key: 'hotel', label: '住宿' },
                    { key: 'ticket', label: '門票' },
                    { key: 'shopping', label: '購物' },
                    { key: 'other', label: '其他' }
                ];

                const convForeign = ref('');
                const convTWD = ref('');
                const calcDisplay = ref('0');
                const calcTarget = ref('');
                const chartType = ref('category');
                let chartInstance = null;
                const chartLegendData = ref([]);

                // TRIPS remain in LocalStorage as requested ("Except for trip page")
                const defaultTrips = [
                    { id: 'bali', title: 'Bali Trip', displayDate: '2026-4/1 ~ 4/6', startDate: '2026-04-01', endDate: '2026-04-06', image: 'https://i.ibb.co/fdndWNk4/banner.jpg', timezone: 'Asia/Makassar' },
                    { id: 'jeju', title: 'Jeju Trip', displayDate: '2026-1/1 ~ 1/4', startDate: '2026-01-01', endDate: '2026-01-04', image: 'https://images.unsplash.com/photo-1572455857811-045a528cc200?auto=format&fit=crop&w=800&q=80', timezone: 'Asia/Seoul' }
                ];
                const trips = ref(loadStorage('myTrip_trips', defaultTrips));
                
                const currentTrip = ref(trips.value[0]); 
                const dates = ref([]);
                const selectedDate = ref({});
                const weather = ref(null);
                const currentTimeTW = ref('');
                const currentTimeLocal = ref('');
                const dynamicTimezone = ref('UTC');
                let timeInterval = null;

                // Flags to prevent infinite loop (Firebase update -> Watcher -> Firebase update)
                let isRemoteUpdateItinerary = false;
                let isRemoteUpdateExpenses = false;
                let isRemoteUpdateInfo = false;

                // --- Firebase Connection Logic ---
                const connectFirebase = (tripId) => {
                    if (!tripId) return;

                    const tripItineraryRef = dbRef(db, `trips/${tripId}/itinerary`);
                    const tripExpensesRef = dbRef(db, `trips/${tripId}/expenses`);
                    const tripInfoRef = dbRef(db, `trips/${tripId}/info`);

                    // Remove existing listeners if switching trips (though openTrip usually switches page context)
                    off(tripItineraryRef);
                    off(tripExpensesRef);
                    off(tripInfoRef);

                    // 1. Itinerary Listener
                    onValue(tripItineraryRef, (snapshot) => {
                        isRemoteUpdateItinerary = true;
                        const data = snapshot.val();
                        itinerary.value = data ? (Array.isArray(data) ? data : Object.values(data)) : [];
                        nextTick(() => { 
                            recalcTimeline(); 
                            isRemoteUpdateItinerary = false; 
                        });
                    });

                    // 2. Expenses Listener
                    onValue(tripExpensesRef, (snapshot) => {
                        isRemoteUpdateExpenses = true;
                        const data = snapshot.val();
                        expenses.value = data ? (Array.isArray(data) ? data : Object.values(data)) : [];
                        nextTick(() => { 
                            if(currentTab.value === 'expenses') renderChart();
                            isRemoteUpdateExpenses = false; 
                        });
                    });

                    // 3. Info Listener
                    onValue(tripInfoRef, (snapshot) => {
                        isRemoteUpdateInfo = true;
                        const data = snapshot.val();
                        // Merge with defaultInfo to ensure structure exists
                        if (data) {
                            info.value = { ...defaultInfo, ...data, flight: { ...defaultInfo.flight, ...data.flight }, hotel: { ...defaultInfo.hotel, ...data.hotel }, visa: { ...defaultInfo.visa, ...data.visa }, checklist: { ...defaultInfo.checklist, ...data.checklist } };
                        } else {
                            info.value = JSON.parse(JSON.stringify(defaultInfo));
                        }
                        nextTick(() => isRemoteUpdateInfo = false);
                    });
                };

                // --------------------- Watchers (Sync Local -> Firebase) ---------------------
                // Only sync if change is NOT from remote
                watch(itinerary, (newVal) => {
                    if (isRemoteUpdateItinerary) return;
                    if (currentTrip.value && currentTrip.value.id) {
                        set(dbRef(db, `trips/${currentTrip.value.id}/itinerary`), newVal);
                    }
                }, { deep: true });

                watch(expenses, (newVal) => {
                    if (isRemoteUpdateExpenses) return;
                    if (currentTrip.value && currentTrip.value.id) {
                        set(dbRef(db, `trips/${currentTrip.value.id}/expenses`), newVal);
                    }
                }, { deep: true });

                watch(info, (newVal) => {
                    if (isRemoteUpdateInfo) return;
                    if (currentTrip.value && currentTrip.value.id) {
                        set(dbRef(db, `trips/${currentTrip.value.id}/info`), newVal);
                    }
                }, { deep: true });

                // LocalStorage persistence for Trips and Currency (unchanged)
                watch(trips, (newVal) => localStorage.setItem('myTrip_trips', JSON.stringify(newVal)), { deep: true });
                watch(currency, (newVal) => localStorage.setItem('myTrip_currency', JSON.stringify(newVal)), { deep: true });
                // ----------------------------------------------------------------

                const filteredItinerary = computed(() => {
                    if (!selectedDate.value || !selectedDate.value.full) return [];
                    return itinerary.value.filter(item => item.date === selectedDate.value.full);
                });

                const filteredExpensesList = computed(() => {
                    let list = expenses.value;
                    if (expenseFilter.value !== 'all') {
                        list = list.filter(e => e.category === expenseFilter.value);
                    }
                    return list.slice().sort((a, b) => {
                        const dateA = new Date(a.date);
                        const dateB = new Date(b.date);
                        return dateB - dateA || b.id - a.id;
                    });
                });

                const totalExpenseFontClass = computed(() => {
                    const val = totalExpensesTWD.value.toLocaleString();
                    const len = val.length + 2; 
                    if (len > 12) return 'text-base';
                    if (len > 10) return 'text-lg';
                    if (len > 8) return 'text-xl';
                    if (len > 6) return 'text-2xl';
                    return 'text-4xl';
                });

                const getLegendValSize = (val) => {
                    const len = val.toLocaleString().length;
                    if (len > 8) return 'text-[7px]';
                    if (len > 6) return 'text-[8px]';
                    return 'text-[9px]';
                };

                const totalExpensesTWD = computed(() => expenses.value.reduce((sum, item) => sum + (item.amountTWD || 0), 0));

                const updateTime = () => {
                    const now = new Date();
                    currentTimeTW.value = now.toLocaleTimeString('en-US', { timeZone: 'Asia/Taipei', hour: '2-digit', minute: '2-digit', hour12: true });
                    const targetZone = dynamicTimezone.value || currentTrip.value.timezone || 'Asia/Taipei';
                    try { 
                        currentTimeLocal.value = now.toLocaleTimeString('en-US', { timeZone: targetZone, hour: '2-digit', minute: '2-digit', hour12: true }); 
                    } catch (e) { 
                        currentTimeLocal.value = '--:--'; 
                    }
                };
                
                const generateTripDates = (startStr, endStr) => { const start = new Date(startStr); const end = new Date(endStr); const dateArray = []; let current = new Date(start); while (current <= end) { const dayName = new Intl.DateTimeFormat('en-US', { weekday: 'short' }).format(current); const month = current.getMonth() + 1; const day = current.getDate(); const fullDate = current.toISOString().split('T')[0]; dateArray.push({ day: dayName, displayDate: `${month}/${day}`, full: fullDate }); current.setDate(current.getDate() + 1); } return dateArray; };
                
                const fetchCountryName = async (lat, lng) => {
                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=3&accept-language=en`);
                        const data = await response.json();
                        if (data && data.address && data.address.country) {
                            return data.address.country;
                        }
                    } catch (e) { console.error("Fetch country failed", e); }
                    return null;
                };

                const fetchWeather = async (lat, lng, forcedLabel = null, forcedTimezone = null) => { 
                    weatherLoading.value = true;
                    try { 
                        const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current=temperature_2m,apparent_temperature,weather_code&timezone=auto`); 
                        const data = await response.json(); 
                        if (forcedTimezone) { dynamicTimezone.value = forcedTimezone; } else if (data.timezone) { dynamicTimezone.value = data.timezone; }
                        updateTime(); 
                        let displayLabel = 'Unknown';
                        if (forcedLabel) { displayLabel = forcedLabel; } else { const country = await fetchCountryName(lat, lng); displayLabel = country || 'LOC'; }
                        if (data.current) { 
                            const code = data.current.weather_code; 
                            let icon = 'fa-cloud'; 
                            if (code === 0) icon = 'fa-sun'; 
                            else if (code <= 3) icon = 'fa-cloud-sun'; 
                            else if (code <= 48) icon = 'fa-smog'; 
                            else if (code <= 67) icon = 'fa-cloud-rain'; 
                            else if (code <= 77) icon = 'fa-snowflake'; 
                            else if (code <= 82) icon = 'fa-cloud-showers-heavy'; 
                            else icon = 'fa-bolt'; 
                            weather.value = { temp: Math.round(data.current.temperature_2m), feelsLike: Math.round(data.current.apparent_temperature), icon: `fa-solid ${icon}`, locationLabel: displayLabel }; 
                        } 
                    } catch (e) {
                        weather.value = { temp: '--', feelsLike: '--', icon: 'fa-solid fa-minus', locationLabel: forcedLabel || '---' };
                    } finally {
                        setTimeout(() => { weatherLoading.value = false; }, 300);
                    }
                };

                const updateDashboardContext = () => {
                    weatherLoading.value = true;
                    const list = filteredItinerary.value;
                    if (list.length > 0) {
                        const first = list[0];
                        fetchWeather(first.lat, first.lng, null, null);
                    } else {
                        fetchWeather(25.0330, 121.5654, 'Taiwan', 'Asia/Taipei');
                    }
                };

                const getCurrentLocationWeather = () => { 
                    if (!navigator.geolocation) return; 
                    weatherLoading.value = true;
                    navigator.geolocation.getCurrentPosition((pos) => { 
                        fetchWeather(pos.coords.latitude, pos.coords.longitude, null, null); 
                    }, (err) => { 
                        updateDashboardContext();
                    }); 
                };

                const fetchExchangeRates = async () => {
                    try {
                        const res = await fetch('https://api.exchangerate-api.com/v4/latest/TWD');
                        const data = await res.json();
                        if (data && data.rates) {
                            const newRates = {};
                            const targetCurrencies = ['JPY', 'USD', 'KRW', 'EUR', 'THB', 'IDR'];
                            targetCurrencies.forEach(code => {
                                if (data.rates[code]) { newRates[code] = 1 / data.rates[code]; } else { newRates[code] = exchangeRates.value[code]; }
                            });
                            exchangeRates.value = newRates;
                            if (currency.value.code && exchangeRates.value[currency.value.code]) { currency.value.rate = exchangeRates.value[currency.value.code]; }
                        }
                    } catch (e) { console.error("Rate fetch failed, using fallback", e); }
                };

                const openTrip = (trip) => { 
                    currentTrip.value = trip; 
                    localStorage.setItem('myTrip_lastTripId', trip.id);
                    
                    // CONNECT TO FIREBASE FOR THIS TRIP
                    connectFirebase(trip.id);

                    if (trip.startDate && trip.endDate) { dates.value = generateTripDates(trip.startDate, trip.endDate); selectedDate.value = dates.value[0] || {}; } else { dates.value = []; } 
                    currentPage.value = 'detail'; 
                    currentTab.value = 'itinerary'; 
                    currentView.value = 'list'; 
                    
                    nextTick(() => {
                        updateDashboardContext();
                        recalcTimeline();
                    });
                    updateTime(); 
                };

                watch(currentTab, (newTab) => {
                    if (newTab === 'expenses') {
                        if (!sessionStorage.getItem('currencySelected')) {
                            showCurrencyModal.value = true;
                            sessionStorage.setItem('currencySelected', 'true');
                        }
                        nextTick(renderChart);
                    }
                    if (newTab === 'itinerary' && currentView.value === 'list') {
                        nextTick(() => initSortable());
                    }
                });

                watch(currentPage, (newVal) => {
                    if (newVal === 'home') {
                        nextTick(() => initSortable());
                    }
                });

                watch(chartType, () => { if(currentTab.value === 'expenses') nextTick(renderChart); });
                
                const selectCurrency = (code) => {
                    currency.value = { code, rate: exchangeRates.value[code] };
                    showCurrencyModal.value = false;
                };

                const onConvForeignInput = () => {
                    if (convForeign.value === '' || convForeign.value === null) { convTWD.value = ''; return; }
                    convTWD.value = Math.round(convForeign.value * currency.value.rate * 100) / 100;
                };
                const onConvTWDInput = () => {
                    if (convTWD.value === '' || convTWD.value === null) { convForeign.value = ''; return; }
                    convForeign.value = Math.round(convTWD.value / currency.value.rate * 100) / 100;
                };
                
                watch(() => currency.value.rate, () => { if (convForeign.value !== '') onConvForeignInput(); });

                const openAddExpenseModal = () => {
                    isEditingExpense.value = false;
                    const today = new Date().toISOString().split('T')[0];
                    expenseForm.value = { id: null, category: 'food', title: '', amountTWD: '', amountForeign: '', date: today, payment: '現金', notes: '' };
                    showExpenseModal.value = true;
                };

                const onInputTwd = () => {
                    if (expenseForm.value.amountTWD === '' || expenseForm.value.amountTWD === null) return;
                    expenseForm.value.amountForeign = Math.round(expenseForm.value.amountTWD / currency.value.rate);
                };
                const onInputForeign = () => {
                    if (expenseForm.value.amountForeign === '' || expenseForm.value.amountForeign === null) return;
                    expenseForm.value.amountTWD = Math.round(expenseForm.value.amountForeign * currency.value.rate);
                };

                const openCalculator = (target) => {
                    calcTarget.value = target;
                    calcDisplay.value = '0';
                    showCalculator.value = true;
                };
                const calcAppend = (n) => { calcDisplay.value = calcDisplay.value === '0' ? n : calcDisplay.value + n; };
                const calcOp = (op) => { if(!['+','-','*','/'].includes(calcDisplay.value.slice(-1))) calcDisplay.value += op; };
                const calcClear = () => { calcDisplay.value = '0'; };
                const calcConfirm = () => {
                    try {
                        const result = eval(calcDisplay.value);
                        if(calcTarget.value === 'twd') { expenseForm.value.amountTWD = Math.round(result); onInputTwd(); } 
                        else if(calcTarget.value === 'foreign') { expenseForm.value.amountForeign = Math.round(result); onInputForeign(); } 
                        else if(calcTarget.value === 'convTWD') { convTWD.value = Math.round(result); onConvTWDInput(); } 
                        else if(calcTarget.value === 'convForeign') { convForeign.value = Math.round(result); onConvForeignInput(); }
                        showCalculator.value = false;
                    } catch(e) { calcDisplay.value = 'Error'; }
                };

                const saveExpense = () => {
                    if (!expenseForm.value.title || !expenseForm.value.amountTWD) return;
                    if (isEditingExpense.value && expenseForm.value.id) {
                        const index = expenses.value.findIndex(e => e.id === expenseForm.value.id);
                        if (index !== -1) { expenses.value[index] = { ...expenseForm.value }; }
                    } else {
                        expenses.value.push({ ...expenseForm.value, id: Date.now() });
                    }
                    // Watcher handles sync
                    showExpenseModal.value = false;
                };

                const getExpenseIcon = (c) => {
                    const map = { food: 'fa-utensils', transport: 'fa-bus', hotel: 'fa-hotel', ticket: 'fa-ticket', shopping: 'fa-bag-shopping', other: 'fa-circle-question' };
                    return `fa-solid ${map[c]}`;
                };

                const renderChart = () => {
                    const ctx = document.getElementById('expenseChart');
                    if(!ctx) return;
                    if(chartInstance) chartInstance.destroy();
                    const dataMap = {};
                    expenses.value.forEach(e => { const key = chartType.value === 'category' ? e.category : e.payment; dataMap[key] = (dataMap[key] || 0) + e.amountTWD; });
                    const colors = ['#fbbf24', '#f59e0b', '#d97706', '#b45309', '#78350f', '#fffbeb'];
                    const categoryMap = { 'food': '飲食', 'transport': '交通', 'hotel': '住宿', 'ticket': '門票', 'shopping': '購物', 'other': '其他' };
                    const rawLabels = Object.keys(dataMap);
                    const translatedLabels = rawLabels.map(key => { if (chartType.value === 'category') { return categoryMap[key] || key; } return key; });
                    const values = Object.values(dataMap);
                    chartLegendData.value = translatedLabels.map((label, index) => { const val = values[index]; const percentage = Math.round((val / totalExpensesTWD.value) * 100) || 0; return { label, value: val, percentage, color: colors[index % colors.length] }; });
                    chartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: translatedLabels, datasets: [{ data: values, backgroundColor: colors, borderWidth: 0, hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { legend: { display: false }, tooltip: { enabled: false } }, hover: { mode: null }, events: [] } });
                };

                const openAddItineraryModal = () => { 
                    isEditingItem.value = false; 
                    let newTime = '09:00';
                    const list = filteredItinerary.value;
                    if (list.length > 0) {
                        const lastItem = list[list.length - 1];
                        const [lh, lm] = lastItem.arrivalTime.split(':').map(Number);
                        const durationMins = (lastItem.durationHr || 0) * 60 + (lastItem.durationMin || 0);
                        const travelMins = lastItem.calculatedTravelTime || 30; 
                        const totalMins = lh * 60 + lm + durationMins + travelMins;
                        const nh = Math.floor(totalMins / 60) % 24;
                        const nm = totalMins % 60;
                        newTime = `${String(nh).padStart(2,'0')}:${String(nm).padStart(2,'0')}`;
                    }

                    itemForm.value = { 
                        id: '', 
                        title: '', 
                        type: 'spot', 
                        arrivalTime: newTime, 
                        durationHr: 1, 
                        durationMin: 30, 
                        lat: -8.5069, 
                        lng: 115.2625, 
                        openingHours: '', 
                        notes: '', 
                        travelMode: 'car',
                        calculatedTravelTime: 0
                    }; 
                    showItemModal.value = true; 
                };
                const openEditItemModal = (item) => { isEditingItem.value = true; itemForm.value = JSON.parse(JSON.stringify(item)); showItemModal.value = true; };
                const closeItemModal = () => { showItemModal.value = false; };
                
                const openTravelTimeModal = (item) => {
                    editingTravelItem.value = item;
                    const totalMins = item.calculatedTravelTime || 0;
                    const h = Math.floor(totalMins / 60);
                    const m = totalMins % 60;
                    const currentMode = item.travelMode || 'car';
                    travelTimeForm.value = {
                        type: item.isManualTravelTime ? 'manual' : 'auto',
                        mode: currentMode,
                        hours: h,
                        minutes: m
                    };
                    showTravelTimeModal.value = true;
                };

                const setTravelMode = (type) => {
                    travelTimeForm.value.type = type;
                };
                
                const getModeName = (mode) => {
                    if (mode === 'car') return '開車';
                    if (mode === 'bus') return '大眾運輸';
                    if (mode === 'walking') return '步行';
                    return '交通';
                };

                const saveTravelTime = () => {
                    if (!editingTravelItem.value) return;
                    const item = itinerary.value.find(i => i.id === editingTravelItem.value.id);
                    if (item) {
                        item.travelMode = travelTimeForm.value.mode;
                        if (travelTimeForm.value.type === 'manual') {
                            const h = parseInt(travelTimeForm.value.hours) || 0;
                            const m = parseInt(travelTimeForm.value.minutes) || 0;
                            const total = h * 60 + m;
                            item.isManualTravelTime = true;
                            item.manualTravelMinutes = total;
                            item.calculatedTravelTime = total; 
                        } else {
                            item.isManualTravelTime = false;
                        }
                    }
                    recalcTimeline(); 
                    showTravelTimeModal.value = false;
                };
                
                const openTimeEditModal = (item) => {
                    editingItemRef = item;
                    if (item.arrivalTime && item.arrivalTime.includes(':')) {
                        const parts = item.arrivalTime.split(':');
                        editingHours.value = parts[0];
                        editingMinutes.value = parts[1];
                    } else {
                        editingHours.value = '09';
                        editingMinutes.value = '00';
                    }
                    showTimeEditModal.value = true;
                };
                
                const saveTime = () => {
                    if (editingItemRef) {
                        let h = parseInt(editingHours.value);
                        let m = parseInt(editingMinutes.value);
                        if (isNaN(h)) h = 0; if (isNaN(m)) m = 0;
                        h = Math.max(0, Math.min(23, h));
                        m = Math.max(0, Math.min(59, m));
                        const timeStr = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                        const targetItem = itinerary.value.find(i => i.id === editingItemRef.id);
                        if (targetItem) {
                            targetItem.arrivalTime = timeStr;
                            recalcTimeline();
                        }
                    }
                    showTimeEditModal.value = false;
                };

                const proceedToMapConfirm = async () => { 
                    if (!itemForm.value.title) return; 
                    const DEFAULT_LAT = 25.0330;
                    const DEFAULT_LNG = 121.5654;
                    try { 
                        const query = encodeURIComponent(itemForm.value.title); 
                        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}&limit=1`); 
                        const data = await response.json(); 
                        if (data && data.length > 0) { 
                            itemForm.value.lat = parseFloat(data[0].lat); 
                            itemForm.value.lng = parseFloat(data[0].lon); 
                        } else {
                            itemForm.value.lat = DEFAULT_LAT;
                            itemForm.value.lng = DEFAULT_LNG;
                        }
                    } catch (e) { 
                        itemForm.value.lat = DEFAULT_LAT;
                        itemForm.value.lng = DEFAULT_LNG;
                    }

                    showItemModal.value = false; 
                    showMapConfirmModal.value = true; 
                    nextTick(() => initConfirmMap()); 
                };

                const initConfirmMap = () => { 
                    if (confirmMapInstance.value) { confirmMapInstance.value.remove(); } 
                    confirmMapInstance.value = L.map('item-confirm-map').setView([itemForm.value.lat, itemForm.value.lng], 14); 
                    L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', { maxZoom: 20, attribution: '© Google' }).addTo(confirmMapInstance.value); 
                    confirmMarker.value = L.marker([itemForm.value.lat, itemForm.value.lng], { draggable: true }).addTo(confirmMapInstance.value); 
                    confirmMarker.value.on('dragend', function(e) { const latlng = e.target.getLatLng(); itemForm.value.lat = latlng.lat; itemForm.value.lng = latlng.lng; }); 
                    confirmMapInstance.value.on('click', function(e) { confirmMarker.value.setLatLng(e.latlng); itemForm.value.lat = e.latlng.lat; itemForm.value.lng = e.latlng.lng; }); 
                    setTimeout(() => confirmMapInstance.value.invalidateSize(), 200); 
                };
                
                const saveItemWithLocation = () => { 
                    const newItem = { ...itemForm.value, id: Date.now(), date: selectedDate.value.full, address: `${itemForm.value.lat.toFixed(4)}, ${itemForm.value.lng.toFixed(4)}` };
                    itinerary.value.push(newItem); 
                    // Watcher syncs
                    recalcTimeline();
                    showMapConfirmModal.value = false; 
                    nextTick(() => { if(currentView.value === 'list') initSortable(); }); 
                };
                
                const saveItemDirectly = () => { 
                    const index = itinerary.value.findIndex(i => i.id === itemForm.value.id); 
                    if (index !== -1) { itinerary.value[index] = { ...itemForm.value }; } 
                    recalcTimeline(); 
                    showItemModal.value = false; 
                };
                
                const confirmDeleteItem = () => { showItemModal.value = false; showDeleteItemConfirmModal.value = true; };
                const executeDeleteItem = () => { 
                    const index = itinerary.value.findIndex(i => i.id === itemForm.value.id); 
                    if (index !== -1) itinerary.value.splice(index, 1); 
                    recalcTimeline(); 
                    showDeleteItemConfirmModal.value = false; 
                    showEditTripModal.value = false; 
                };
                
                const getDistance = (lat1, lon1, lat2, lon2) => { const R = 6371; const dLat = (lat2 - lat1) * (Math.PI / 180); const dLon = (lon2 - lon1) * (Math.PI / 180); const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) * Math.sin(dLon / 2) * Math.sin(dLon / 2); const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)); return R * c; };
                
                const fetchRouteDuration = async (startLat, startLng, endLat, endLng, mode) => {
                    let profile = 'driving';
                    if (mode === 'walking') profile = 'walking';
                    const url = `https://router.project-osrm.org/route/v1/${profile}/${startLng},${startLat};${endLng},${endLat}?overview=false`;
                    try {
                        const res = await fetch(url);
                        const data = await res.json();
                        if (data.routes && data.routes.length > 0) {
                            let durationSeconds = data.routes[0].duration;
                            if (mode === 'bus') { durationSeconds = (durationSeconds * 1.5) + (10 * 60); }
                            return Math.round(durationSeconds / 60);
                        }
                    } catch (e) { console.warn("OSRM fetch failed, falling back to math", e); }
                    return null;
                };

                const formatTravelTime = (mins) => {
                    if (!mins || mins < 0) return '0 min';
                    if (mins < 60) return `${mins} min`;
                    const h = Math.floor(mins / 60);
                    const m = mins % 60;
                    return `${h} hr ${m} min`;
                };

                const calculateTravelTime = (item1, item2) => { 
                    if (!item1 || !item2) return '-- min'; 
                    return formatTravelTime(item1.calculatedTravelTime);
                };

                const getTravelIcon = (mode) => { if (mode === 'walking') return 'fa-solid fa-person-walking'; if (mode === 'bus') return 'fa-solid fa-bus-simple'; return 'fa-solid fa-car'; };
                const toggleTravelMode = (item) => { 
                    const modes = ['car', 'bus', 'walking']; 
                    const currentIdx = modes.indexOf(item.travelMode || 'car'); 
                    const nextMode = modes[(currentIdx + 1) % 3]; 
                    item.travelMode = nextMode; 
                    item.isManualTravelTime = false; 
                    recalcTimeline(); 
                };
                const triggerFileInput = (id) => { document.getElementById(id).click(); };
                const handleImageUpload = (event, type) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { const currentUser = info.value[type].currentUser; info.value[type].images[currentUser] = e.target.result; }; reader.readAsDataURL(file); };
                const toggleUser = (type) => { info.value[type].currentUser = info.value[type].currentUser === 'user1' ? 'user2' : 'user1'; };
                
                const openAddTripModal = () => {
                    const today = new Date().toISOString().split('T')[0];
                    newTrip.value = { title: '', start: today, end: today, image: null };
                    showAddTripModal.value = true;
                };
                const handleTripImageUpload = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (evt) => { newTrip.value.image = evt.target.result; };
                        reader.readAsDataURL(file);
                    }
                };
                const saveNewTrip = () => {
                    const tripImage = newTrip.value.image || 'https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?auto=format&fit=crop&w=800&q=80';
                    const startD = new Date(newTrip.value.start);
                    const endD = new Date(newTrip.value.end);
                    const displayDateStr = `${startD.getFullYear()}-${startD.getMonth()+1}/${startD.getDate()} ~ ${endD.getMonth()+1}/${endD.getDate()}`;
                    trips.value.unshift({ id: Date.now().toString(), title: newTrip.value.title, startDate: newTrip.value.start, endDate: newTrip.value.end, displayDate: displayDateStr, image: tripImage, timezone: 'UTC' });
                    showAddTripModal.value = false;
                };

                const autoResize = (el) => { if (!el) return; el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; };

                const resizeAllTextareas = () => {
                    nextTick(() => {
                        const textareas = document.querySelectorAll('.auto-resize-textarea');
                        textareas.forEach(el => autoResize(el));
                    });
                };

                watch(filteredItinerary, () => {
                    if (currentView.value === 'list') resizeAllTextareas();
                }, { deep: true });
                
                watch(selectedDate, (newVal, oldVal) => {
                    if (newVal.full !== oldVal?.full) {
                        updateDashboardContext();
                    }
                });

                const switchView = (view) => { 
                    currentView.value = view; 
                    if (view === 'map') { 
                        nextTick(() => { 
                            setTimeout(() => { 
                                initMap(); 
                                if(mapInstance.value) mapInstance.value.invalidateSize(); 
                            }, 200); 
                        }); 
                    } else { 
                        nextTick(() => {
                            initSortable(); 
                            resizeAllTextareas();
                        });
                    } 
                };

                const openEditModal = (trip) => { editingTrip.value = { ...trip, start: trip.startDate, end: trip.endDate }; showDeleteConfirmModal.value = false; showEditTripModal.value = true; };
                const saveEditedTrip = () => { const index = trips.value.findIndex(t => t.id === editingTrip.value.id); if (index !== -1) { const startD = new Date(editingTrip.value.start); const endD = new Date(editingTrip.value.end); const displayDateStr = `${startD.getFullYear()}-${startD.getMonth()+1}/${startD.getDate()} ~ ${endD.getMonth()+1}/${endD.getDate()}`; trips.value[index] = { ...editingTrip.value, startDate: editingTrip.value.start, endDate: editingTrip.value.end, displayDate: displayDateStr }; if(currentTrip.value.id === editingTrip.value.id) { currentTrip.value = trips.value[index]; if (editingTrip.value.startDate && editingTrip.value.endDate) { dates.value = generateTripDates(currentTrip.value.startDate, currentTrip.value.endDate); selectedDate.value = dates.value[0]; } } } showEditTripModal.value = false; };
                const deleteTrip = () => { showDeleteConfirmModal.value = true; };
                const confirmDelete = () => { const index = trips.value.findIndex(t => t.id === editingTrip.value.id); if (index !== -1) trips.value.splice(index, 1); showDeleteConfirmModal.value = false; showEditTripModal.value = false; };
                const getDepartureTime = (start, durationHr, durationMin) => { if (!start) return '--:--'; const [h, m] = start.split(':').map(Number); let endH = h + parseInt(durationHr); let endM = m + parseInt(durationMin); if (endM >= 60) { endH += Math.floor(endM / 60); endM = endM % 60; } endH = endH % 24; return `${String(endH).padStart(2, '0')}:${String(endM).padStart(2, '0')}`; };
                
                const getCategoryIcon = (type) => { 
                    if(type === 'airport') return 'fa-solid fa-plane'; 
                    if(type === 'hotel') return 'fa-solid fa-hotel'; 
                    if(type === 'food') return 'fa-solid fa-utensils'; 
                    return 'fa-solid fa-location-dot'; 
                };
                
                const getMarkerColor = (type) => { if(type === 'airport') return '#a8a29e'; if(type === 'hotel') return '#818cf8'; if(type === 'food') return '#fbbf24'; return '#60a5fa'; };
                const getTypeBorderColor = (type) => getMarkerColor(type);
                
                const initSortable = () => { 
                    if (sortableInstance) { sortableInstance.destroy(); sortableInstance = null; } 
                    setTimeout(() => { 
                        const el = document.getElementById('itinerary-list'); 
                        if (el && typeof Sortable !== 'undefined') { 
                            sortableInstance = Sortable.create(el, { 
                                animation: 200, delay: 300, delayOnTouchOnly: true, touchStartThreshold: 5, ghostClass: 'sortable-ghost', dragClass: 'sortable-drag', chosenClass: 'sortable-chosen', filter: ".no-drag", preventOnFilter: false, 
                                onEnd: (evt) => { 
                                    const newIndex = evt.newIndex;
                                    const oldIndex = evt.oldIndex;
                                    const dayStr = selectedDate.value.full;
                                    const otherDaysItems = itinerary.value.filter(i => i.date !== dayStr);
                                    let newDayItems = itinerary.value.filter(i => i.date === dayStr); 
                                    const newOrderIds = sortableInstance.toArray(); 
                                    const reorderedDayItems = newOrderIds.map(id => newDayItems.find(i => i.id == id)).filter(i => i); 
                                    // Update array, watcher will sync to Firebase
                                    itinerary.value = [...otherDaysItems, ...reorderedDayItems];
                                    recalcTimeline(); 
                                } 
                            }); 
                        } 
                    }, 350); 

                    if (tripSortableInstance) { tripSortableInstance.destroy(); tripSortableInstance = null; }
                    setTimeout(() => {
                        const tripListEl = document.getElementById('trip-list');
                        if (tripListEl && typeof Sortable !== 'undefined') {
                            tripSortableInstance = Sortable.create(tripListEl, {
                                animation: 200, delay: 300, delayOnTouchOnly: true, touchStartThreshold: 5, ghostClass: 'sortable-ghost', dragClass: 'sortable-drag', chosenClass: 'sortable-chosen', filter: ".no-drag", preventOnFilter: false,
                                onEnd: (evt) => {
                                    const item = trips.value.splice(evt.oldIndex, 1)[0];
                                    trips.value.splice(evt.newIndex, 0, item);
                                }
                            });
                        }
                    }, 350);
                };

                const recalcTimeline = async () => { 
                    const list = filteredItinerary.value; 
                    if (list.length === 0) return; 
                    if (!list[0].arrivalTime) list[0].arrivalTime = '09:00'; 
                    
                    for (let i = 0; i < list.length - 1; i++) { 
                        const curr = list[i]; 
                        const next = list[i+1];
                        if (curr.isManualTravelTime) {
                        } else {
                            const dist = getDistance(curr.lat, curr.lng, next.lat, next.lng); 
                            let speed = 30; if (curr.travelMode === 'walking') speed = 4; if (curr.travelMode === 'bus') speed = 15; 
                            let travelMins = Math.round((dist / speed) * 60); 
                            if (curr.travelMode === 'bus') travelMins += 10; 
                            if (travelMins < 1) travelMins = 1;
                            curr.calculatedTravelTime = travelMins;
                        }
                    }

                    updateArrivalTimes(list);

                    for (let i = 0; i < list.length - 1; i++) {
                        const curr = list[i];
                        const next = list[i+1];
                        if (!curr.isManualTravelTime) {
                            const realDurationMins = await fetchRouteDuration(curr.lat, curr.lng, next.lat, next.lng, curr.travelMode);
                            if (realDurationMins !== null) {
                                curr.calculatedTravelTime = realDurationMins;
                                updateArrivalTimes(list);
                            }
                        }
                    }
                };

                const updateArrivalTimes = (list) => {
                    for (let i = 0; i < list.length - 1; i++) {
                        const curr = list[i];
                        const next = list[i+1];
                        const [ph, pm] = curr.arrivalTime.split(':').map(Number); 
                        const prevStartMins = ph * 60 + pm; 
                        const prevDurationMins = (curr.durationHr || 0) * 60 + (curr.durationMin || 0); 
                        const prevEndMins = prevStartMins + prevDurationMins; 
                        const travelMins = curr.calculatedTravelTime || 0;
                        const currStartMins = prevEndMins + travelMins; 
                        const nh = Math.floor(currStartMins / 60) % 24; 
                        const nm = currStartMins % 60; 
                        next.arrivalTime = `${String(nh).padStart(2,'0')}:${String(nm).padStart(2,'0')}`; 
                    }
                };

                const initMap = () => { 
                    if (mapInstance.value) { mapInstance.value.remove(); mapInstance.value = null; } 
                    mapInstance.value = L.map('map', { zoomControl: false, attributionControl: false }).setView([-8.5069, 115.2625], 13); 
                    L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', { maxZoom: 20, attribution: '© Google' }).addTo(mapInstance.value); 
                    const list = filteredItinerary.value; 
                    if (list.length > 0) { 
                        const markers = list.map((item, index) => {
                            const num = index + 1;
                            const icon = L.divIcon({ className: 'custom-div-icon', html: `<div class="marker-pin">${num}</div>`, iconSize: [30, 42], iconAnchor: [15, 21] });
                            return L.marker([item.lat, item.lng], { icon: icon }).addTo(mapInstance.value);
                        }); 
                        const group = L.featureGroup(markers); 
                        mapInstance.value.fitBounds(group.getBounds(), { padding: [50, 50] }); 
                    } 
                };
                
                const getMapUrl = (item) => {
                    if (item.lat != null && item.lng != null) { return `https://www.google.com/maps/dir/?api=1&destination=${item.lat},${item.lng}`; }
                    const query = item.address || item.title;
                    if (!query) return '#';
                    return `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(query)}`;
                };

                const openHotelModal = () => { hotelForm.value = { ...info.value.hotel.list[info.value.hotel.currentIndex] }; showHotelModal.value = true; };
                
                const proceedToHotelMapConfirm = async () => { 
                    const DEFAULT_LAT = 25.0330;
                    const DEFAULT_LNG = 121.5654;
                    if (hotelForm.value.name) { 
                        try { 
                            const query = encodeURIComponent(hotelForm.value.name); 
                            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}&limit=1`); 
                            const data = await response.json(); 
                            if (data && data.length > 0) { 
                                hotelForm.value.lat = parseFloat(data[0].lat); 
                                hotelForm.value.lng = parseFloat(data[0].lon); 
                            } else {
                                hotelForm.value.lat = DEFAULT_LAT;
                                hotelForm.value.lng = DEFAULT_LNG;
                            }
                        } catch (e) { 
                            hotelForm.value.lat = DEFAULT_LAT;
                            hotelForm.value.lng = DEFAULT_LNG;
                        } 
                    } 
                    showHotelModal.value = false; 
                    showHotelMapModal.value = true; 
                    nextTick(() => initHotelMap()); 
                };
                
                const initHotelMap = () => { if (hotelMapInstance.value) { hotelMapInstance.value.remove(); } let lat = hotelForm.value.lat || -8.5069; let lng = hotelForm.value.lng || 115.2625; hotelMapInstance.value = L.map('hotel-confirm-map').setView([lat, lng], 15); L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', { maxZoom: 20, attribution: '© Google' }).addTo(hotelMapInstance.value); hotelMapMarker.value = L.marker([lat, lng], { draggable: true }).addTo(hotelMapInstance.value); hotelMapMarker.value.on('dragend', function(e) { const latlng = e.target.getLatLng(); hotelForm.value.lat = latlng.lat; hotelForm.value.lng = latlng.lng; }); hotelMapInstance.value.on('click', function(e) { hotelMapMarker.value.setLatLng(e.latlng); hotelForm.value.lat = e.latlng.lat; hotelForm.value.lng = e.latlng.lng; }); setTimeout(() => hotelMapInstance.value.invalidateSize(), 200); };
                const confirmHotelLocation = () => { info.value.hotel.list[info.value.hotel.currentIndex] = { ...hotelForm.value }; showHotelMapModal.value = false; };
                const toggleHotel = () => { info.value.hotel.currentIndex = (info.value.hotel.currentIndex + 1) % 5; };

                const openAddChecklistModal = (category) => { targetChecklistCategory.value = category; newChecklistItemName.value = ''; showAddChecklistModal.value = true; };
                const confirmAddChecklistItem = () => { if (newChecklistItemName.value.trim()) { if (!info.value.checklist[targetChecklistCategory.value]) { info.value.checklist[targetChecklistCategory.value] = []; } info.value.checklist[targetChecklistCategory.value].push({ name: newChecklistItemName.value.trim(), checked: false }); } showAddChecklistModal.value = false; };
                
                const checklistDeleteTarget = ref({ category: null, index: null });
                let longPressTimer = null;
                
                const startLongPress = (category, index) => { 
                    longPressTimer = setTimeout(() => {
                        checklistDeleteTarget.value = { category, index };
                        showDeleteChecklistConfirmModal.value = true;
                    }, 600); 
                };
                const clearLongPress = () => { if (longPressTimer) clearTimeout(longPressTimer); };
                const toggleChecklist = (item) => { item.checked = !item.checked; };
                const executeDeleteChecklistItem = () => { 
                    const { category, index } = checklistDeleteTarget.value;
                    if (category && index !== null && info.value.checklist[category]) {
                        info.value.checklist[category].splice(index, 1);
                    }
                    showDeleteChecklistConfirmModal.value = false; 
                };

                const openFlightModal = (type) => { editingFlightType.value = type; const currentData = info.value.flight[type]; let depTimeStr = currentData.dep || ''; let arrTimeStr = currentData.arr || ''; flightForm.value = { depAirport: currentData.depAirport, arrAirport: currentData.arrAirport, number: currentData.number, depTime: depTimeStr, arrTime: arrTimeStr, arrDayOffset: currentData.arrDayOffset || 0, duration: currentData.duration }; showFlightModal.value = true; };
                
                const getAirportOffsetMinutes = async (query) => {
                    try {
                        const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?q=${query}+airport&format=json&limit=1`);
                        const geoData = await geoRes.json();
                        if (!geoData || geoData.length === 0) return null;
                        const { lat, lon } = geoData[0];
                        const tzRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=weather_code&timezone=auto`);
                        const tzData = await tzRes.json();
                        return tzData.utc_offset_seconds / 60;
                    } catch (e) { console.error(`Failed to get offset for ${query}`, e); return null; }
                };

                const saveFlight = async () => { 
                    isCalculatingFlight.value = true; 
                    try { 
                        const { depTime, arrTime, depAirport, arrAirport, arrDayOffset } = flightForm.value; 
                        let calculatedDuration = ""; 
                        if (depAirport && arrAirport && depTime && arrTime) { 
                            const depOffsetMinutes = await getAirportOffsetMinutes(depAirport);
                            const arrOffsetMinutes = await getAirportOffsetMinutes(arrAirport);
                            if (depOffsetMinutes !== null && arrOffsetMinutes !== null) {
                                const [depH, depM] = depTime.split(':').map(Number);
                                const [arrH, arrM] = arrTime.split(':').map(Number);
                                const depUtcMinutes = (depH * 60 + depM) - depOffsetMinutes;
                                const arrUtcMinutes = (arrH * 60 + arrM) - arrOffsetMinutes + (arrDayOffset * 24 * 60);
                                let diffMinutes = arrUtcMinutes - depUtcMinutes;
                                if (diffMinutes < 0) diffMinutes += (24 * 60);
                                const hours = Math.floor(diffMinutes / 60);
                                const minutes = Math.floor(diffMinutes % 60);
                                calculatedDuration = `${hours}h ${minutes}m`;
                            }
                        } 
                        if (!calculatedDuration) { 
                            const [depH, depM] = depTime.includes(':') ? depTime.split(':').map(Number) : [0,0]; 
                            const [arrH, arrM] = arrTime.includes(':') ? arrTime.split(':').map(Number) : [0,0];
                            const depMin = depH * 60 + depM; 
                            const arrMin = arrH * 60 + arrM + (arrDayOffset * 1440); 
                            let diff = arrMin - depMin; 
                            if (diff < 0) diff += 1440; 
                            const hours = Math.floor(diff / 60); 
                            const minutes = diff % 60; 
                            calculatedDuration = `${hours}h ${minutes}m (Est)`; 
                        } 
                        info.value.flight[editingFlightType.value] = { ...info.value.flight[editingFlightType.value], depAirport: flightForm.value.depAirport, arrAirport: flightForm.value.arrAirport, number: flightForm.value.number, dep: depTime, arr: arrTime, arrDayOffset: arrDayOffset, duration: calculatedDuration }; 
                    } catch (e) { console.error("Flight calculation error", e); } finally { isCalculatingFlight.value = false; showFlightModal.value = false; } 
                };
                const toggleFlightType = () => { currentFlightType.value = currentFlightType.value === 'out' ? 'in' : 'out'; };


                onMounted(() => {
                    if (currentTrip.value.startDate && currentTrip.value.endDate) { dates.value = generateTripDates(currentTrip.value.startDate, currentTrip.value.endDate); selectedDate.value = dates.value[0] || {}; }
                    
                    updateDashboardContext();

                    initSortable(); timeInterval = setInterval(updateTime, 1000); updateTime();
                    fetchExchangeRates(); 
                    resizeAllTextareas();
                });
                onUnmounted(() => { if (timeInterval) clearInterval(timeInterval); });

                return {
                    currentPage, trips, currentTrip, openTrip, currentTab, currentView, switchView, selectedItem,
                    getTypeBorderColor, getMarkerColor, dates, selectedDate,
                    showAddTripModal, newTrip, saveNewTrip, openAddTripModal, handleTripImageUpload,
                    showEditTripModal, editingTrip, openEditModal, saveEditedTrip, deleteTrip, confirmDelete, showDeleteConfirmModal,
                    weather, getCurrentLocationWeather, currentTimeTW, currentTimeLocal,
                    itinerary, filteredItinerary, showItemModal, itemForm, openAddItineraryModal, openEditItemModal, closeItemModal, proceedToMapConfirm, saveItemWithLocation, saveItemDirectly, isEditingItem,
                    showDeleteItemConfirmModal, confirmDeleteItem, executeDeleteItem, showMapConfirmModal,
                    timeOptions, getDepartureTime, getCategoryIcon, calculateTravelTime, getTravelIcon, toggleTravelMode, recalcTimeline,
                    info, triggerFileInput, handleImageUpload, toggleUser,
                    expenses, currency, showCurrencyModal, exchangeRates, selectCurrency, showExpenseModal, expenseForm, openAddExpenseModal, saveExpense, getExpenseIcon,
                    onInputTwd, onInputForeign, totalExpensesTWD, totalExpenseFontClass, chartType,
                    showCalculator, calcDisplay, openCalculator, calcAppend, calcOp, calcClear, calcConfirm,
                    chartLegendData, convForeign, convTWD, onConvForeignInput, onConvTWDInput, expenseFilter, filteredExpensesList, expenseCategories, getLegendValSize,
                    activeExpenseMenuId, toggleExpenseMenu, editExpense, isEditingExpense,
                    confirmDeleteExpense, executeDeleteExpense, showDeleteExpenseConfirmModal,
                    showHotelModal, hotelForm, openHotelModal, toggleHotel,
                    showHotelMapModal, proceedToHotelMapConfirm, confirmHotelLocation,
                    showAddChecklistModal, newChecklistItemName, targetChecklistCategory, openAddChecklistModal, confirmAddChecklistItem,
                    startLongPress, clearLongPress, toggleChecklist, showDeleteChecklistConfirmModal, executeDeleteChecklistItem,
                    showFlightModal, flightForm, openFlightModal, saveFlight, editingFlightType, toggleFlightType, currentFlightType, isCalculatingFlight, timeSelectOptions,
                    autoResize, itemTypes, weatherLoading,
                    showTravelTimeModal, travelTimeForm, openTravelTimeModal, setTravelMode, saveTravelTime, formatTravelTime, getModeName,
                    showTimeEditModal, editingHours, editingMinutes, openTimeEditModal, saveTime, validateTimeInput,
                    validateDurationInput, getMapUrl
                };
            }
        }).mount('#app');
    </script>
</body>
</html>